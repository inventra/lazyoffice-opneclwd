async function loadSettings() {
  try {
    const response = await fetch('/api/security/settings');
    const settings = await response.json();
    
    document.getElementById('scan-interval').value = 
      settings.port_scan_interval_hours || 1;
    
    if (settings.last_port_scan) {
      const date = new Date(settings.last_port_scan);
      document.getElementById('last-scan-time').textContent = 
        date.toLocaleString('zh-TW');
    }
  } catch (error) {
    console.error('Failed to load settings:', error);
  }
}

async function loadScanResults() {
  try {
    const response = await fetch('/api/security/scan/latest');
    const data = await response.json();
    
    const container = document.getElementById('scan-results');
    
    if (!data.results || data.results.length === 0) {
      container.innerHTML = '<div class="loading">å°šæœªåŸ·è¡Œæƒæã€‚è«‹é»æ“Šã€Œç«‹å³æƒæã€æŒ‰éˆ•ã€‚</div>';
      return;
    }
    
    // é¡¯ç¤ºçµ±è¨ˆè³‡æ–™
    const openCount = data.results.filter(r => r.status === 'open').length;
    const closedCount = data.results.filter(r => r.status === 'closed').length;
    
    document.getElementById('scan-meta').style.display = 'flex';
    document.getElementById('total-ports').textContent = data.results.length;
    document.getElementById('open-ports').textContent = openCount;
    document.getElementById('closed-ports').textContent = closedCount;
    
    // æ¸²æŸ“çµæœåˆ—è¡¨
    container.className = 'scan-results';
    container.innerHTML = data.results.map(port => `
      <div class="port-item">
        <div class="port-info">
          <div class="port-number">${port.port}</div>
          <div class="port-service">${port.service}</div>
        </div>
        <div style="display:flex;gap:10px;align-items:center;">
          <span class="risk-badge risk-${port.risk_level}">${getRiskLabel(port.risk_level)}</span>
          <span class="port-status status-${port.status}">${getStatusLabel(port.status)}</span>
        </div>
      </div>
    `).join('');
    
  } catch (error) {
    console.error('Failed to load scan results:', error);
    document.getElementById('scan-results').innerHTML = 
      '<div class="loading">âŒ è¼‰å…¥å¤±æ•—ï¼š' + error.message + '</div>';
  }
}

async function saveInterval() {
  const interval = document.getElementById('scan-interval').value;
  
  try {
    const response = await fetch('/api/security/settings', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        key: 'port_scan_interval_hours',
        value: interval
      })
    });
    
    if (response.ok) {
      alert('âœ… æƒæé »ç‡å·²æ›´æ–°');
    } else {
      alert('âŒ æ›´æ–°å¤±æ•—');
    }
  } catch (error) {
    console.error('Failed to save interval:', error);
    alert('âŒ æ›´æ–°å¤±æ•—ï¼š' + error.message);
  }
}

async function runScan() {
  const btn = event.target;
  btn.disabled = true;
  btn.textContent = 'ğŸ” æƒæä¸­...';
  
  const startTime = Date.now();
  
  try {
    const response = await fetch('/api/security/scan', { method: 'POST' });
    const result = await response.json();
    
    const duration = Date.now() - startTime;
    
    if (result.scanned_at) {
      document.getElementById('scan-duration').textContent = duration + ' ms';
      await loadSettings();
      await loadScanResults();
      alert(`âœ… æƒæå®Œæˆï¼\né–‹æ”¾ï¼š${result.open} å€‹\né—œé–‰ï¼š${result.closed} å€‹`);
    } else {
      alert('âŒ æƒæå¤±æ•—');
    }
  } catch (error) {
    console.error('Scan failed:', error);
    alert('âŒ æƒæå¤±æ•—ï¼š' + error.message);
  } finally {
    btn.disabled = false;
    btn.textContent = 'ğŸ” ç«‹å³æƒæ';
  }
}

function getRiskLabel(level) {
  const labels = {
    'high': 'High Risk',
    'medium': 'Medium',
    'low': 'Low',
    'safe': 'Safe'
  };
  return labels[level] || level;
}

function getStatusLabel(status) {
  return status === 'open' ? 'é–‹æ”¾' : 'é—œé–‰';
}

// Prompt Guard åŠŸèƒ½
async function loadPromptGuardSettings() {
  try {
    const response = await fetch('/api/security/settings');
    const settings = await response.json();
    
    const enabled = settings.prompt_guard_enabled === 'true';
    document.getElementById('prompt-guard-toggle').checked = enabled;
    
    // è¼‰å…¥çµ±è¨ˆ
    await loadPromptGuardStats();
  } catch (error) {
    console.error('Failed to load prompt guard settings:', error);
  }
}

async function loadPromptGuardStats() {
  try {
    const response = await fetch('/api/security/prompt-guard/stats?hours=24');
    const stats = await response.json();
    
    document.getElementById('pg-total').textContent = stats.total_count || 0;
    document.getElementById('pg-safe').textContent = stats.safe_count || 0;
    document.getElementById('pg-suspicious').textContent = stats.suspicious_count || 0;
    document.getElementById('pg-blocked').textContent = stats.blocked_count || 0;
  } catch (error) {
    console.error('Failed to load prompt guard stats:', error);
  }
}

async function testPrompt() {
  const promptInput = document.getElementById('test-prompt');
  const resultDiv = document.getElementById('test-result');
  const prompt = promptInput.value.trim();
  
  if (!prompt) {
    alert('è«‹è¼¸å…¥æ¸¬è©¦æ–‡å­—');
    return;
  }
  
  resultDiv.style.display = 'block';
  resultDiv.innerHTML = '<div class="loading">æ¸¬è©¦ä¸­...</div>';
  
  try {
    const response = await fetch('/api/security/prompt-guard/test', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ prompt })
    });
    
    if (!response.ok) {
      const error = await response.json();
      throw new Error(error.error || 'Test failed');
    }
    
    const result = await response.json();
    
    // æ ¹æ“šçµæœé¡¯ç¤ºä¸åŒé¡è‰²
    const bgColor = result.isSafe ? '#e8f5e9' : '#ffebee';
    const textColor = result.isSafe ? '#2e7d32' : '#c62828';
    const icon = result.isSafe ? 'âœ…' : 'âŒ';
    
    resultDiv.style.background = bgColor;
    resultDiv.style.color = textColor;
    resultDiv.style.border = `1px solid ${textColor}`;
    
    resultDiv.innerHTML = `
      <div style="font-weight: bold; margin-bottom: 10px;">
        ${icon} ${result.isSafe ? 'å®‰å…¨' : 'å¯ç–‘/å±éšª'}
      </div>
      <div style="margin-bottom: 8px;">
        <strong>é¢¨éšªç­‰ç´šï¼š</strong>
        <span class="risk-badge risk-${result.riskLevel}">${result.riskLevel.toUpperCase()}</span>
      </div>
      <div style="margin-bottom: 8px;">
        <strong>åŸå› ï¼š</strong> ${result.reason}
      </div>
      <div style="font-size: 12px; color: #666;">
        <strong>ä¿¡å¿ƒåº¦ï¼š</strong> ${(result.confidence * 100).toFixed(0)}%
        ${result.tokensUsed ? ` | <strong>Token æ¶ˆè€—ï¼š</strong> ${result.tokensUsed}` : ''}
      </div>
    `;
    
  } catch (error) {
    console.error('Test failed:', error);
    resultDiv.style.background = '#ffebee';
    resultDiv.style.border = '1px solid #c62828';
    resultDiv.innerHTML = `âŒ æ¸¬è©¦å¤±æ•—ï¼š${error.message}`;
  }
}

// Toggle é–‹é—œäº‹ä»¶
document.getElementById('prompt-guard-toggle').addEventListener('change', async function() {
  const enabled = this.checked;
  
  try {
    const response = await fetch('/api/security/settings', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        key: 'prompt_guard_enabled',
        value: enabled ? 'true' : 'false'
      })
    });
    
    if (response.ok) {
      const status = enabled ? 'å·²å•Ÿç”¨' : 'å·²åœç”¨';
      alert(`âœ… Prompt Guard ${status}`);
    } else {
      alert('âŒ è¨­å®šå¤±æ•—');
      this.checked = !enabled; // æ¢å¾©åŸç‹€
    }
  } catch (error) {
    console.error('Failed to toggle prompt guard:', error);
    alert('âŒ è¨­å®šå¤±æ•—ï¼š' + error.message);
    this.checked = !enabled; // æ¢å¾©åŸç‹€
  }
});

// åˆå§‹è¼‰å…¥
loadSettings();
loadScanResults();
loadPromptGuardSettings();
