<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å·æ‡¶è¾¦å…¬å®¤ â€” Lazy Office</title>
<style>
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

body {
  background: #0a0a1a;
  color: #e8d5b7;
  font-family: "Segoe UI", "PingFang TC", "Microsoft JhengHei", sans-serif;
  overflow: hidden;
  height: 100vh;
  display: flex;
  flex-direction: column;
  user-select: none;
  -webkit-user-select: none;
}

/* ===== Header ===== */
header {
  text-align: center;
  padding: 10px 0 6px;
  background: linear-gradient(180deg, #16213e 0%, #0f1a30 100%);
  border-bottom: 1px solid #1a3a5c;
  flex-shrink: 0;
}
header h1 {
  font-size: 20px;
  letter-spacing: 4px;
  font-weight: 700;
  text-shadow: 0 2px 8px rgba(0,0,0,.5);
}
header h1 span { color: #f0a500; }

/* ===== Office Tabs (Feature 10) ===== */
.tab-bar {
  display: flex;
  align-items: center;
  background: #0d1525;
  border-bottom: 1px solid #1a3a5c;
  flex-shrink: 0;
  padding: 0 8px;
  gap: 2px;
  overflow-x: auto;
  min-height: 36px;
}
.tab-bar::-webkit-scrollbar { height: 0; }

.tab {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 7px 14px;
  background: transparent;
  color: #667788;
  border: none;
  border-bottom: 2px solid transparent;
  cursor: pointer;
  font-size: 12px;
  white-space: nowrap;
  transition: all .15s;
  position: relative;
}
.tab:hover { color: #a0b0c0; background: rgba(255,255,255,.03); }
.tab.active {
  color: #e8d5b7;
  border-bottom-color: #f0a500;
  background: rgba(240,165,0,.06);
}
.tab .tab-close {
  display: none;
  width: 16px; height: 16px;
  border-radius: 3px;
  border: none;
  background: transparent;
  color: #667788;
  font-size: 14px;
  line-height: 1;
  cursor: pointer;
  padding: 0;
}
.tab:hover .tab-close { display: flex; align-items: center; justify-content: center; }
.tab .tab-close:hover { background: rgba(255,80,80,.2); color: #ff6b6b; }

.tab-add {
  padding: 6px 12px;
  background: transparent;
  border: 1px dashed #2a3a5c;
  border-radius: 5px;
  color: #556677;
  cursor: pointer;
  font-size: 13px;
  margin-left: 4px;
  transition: all .15s;
  flex-shrink: 0;
}
.tab-add:hover { border-color: #f0a500; color: #f0a500; background: rgba(240,165,0,.06); }

/* ===== Main Layout ===== */
.main { display: flex; flex: 1; overflow: hidden; }

.canvas-wrap {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 16px;
  position: relative;
  background: radial-gradient(ellipse at center, #111122 0%, #0a0a1a 100%);
  overflow: hidden;
  min-height: 0;
}

.canvas {
  position: relative;
  max-width: 100%;
  max-height: 100%;
  border-radius: 8px;
  box-shadow: 0 8px 40px rgba(0,0,0,.6), 0 0 0 1px rgba(255,255,255,.05);
  overflow: hidden;
  line-height: 0;
  aspect-ratio: 2752 / 1536;
}

.canvas img.bg {
  display: block;
  width: 100%;
  height: 100%;
  object-fit: cover;
  pointer-events: none;
}

/* Placeholder background for AI offices */
.canvas .bg-placeholder {
  width: 960px;
  height: 540px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: linear-gradient(135deg, #1a2240 0%, #0d1525 50%, #162035 100%);
  color: #334455;
  font-size: 14px;
  text-align: center;
  line-height: 1.6;
  pointer-events: none;
}

/* ===== Sloth Elements ===== */
.sloth {
  position: absolute;
  cursor: grab;
  touch-action: none;
  transform-origin: center center;
  transition: outline-color 0.2s;
}
.sloth img {
  display: block;
  pointer-events: none;
  width: 100%;
  height: auto;
  filter: drop-shadow(0 2px 4px rgba(0,0,0,.4));
  object-fit: contain;
}
.sloth.selected {
  outline: 3px solid #00e676;
  outline-offset: 2px;
  border-radius: 4px;
}
.sloth:active { cursor: grabbing; }

.sloth .name-tag {
  position: absolute;
  bottom: -38px;
  left: 50%;
  transform: translateX(-50%);
  background: linear-gradient(135deg, rgba(30,30,50,.92), rgba(20,20,40,.92));
  backdrop-filter: blur(8px);
  padding: 4px 14px 5px;
  border-radius: 8px;
  white-space: nowrap;
  pointer-events: none;
  border: 1px solid rgba(255,255,255,.12);
  box-shadow: 0 2px 10px rgba(0,0,0,.5);
  text-align: center;
  line-height: 1.3;
}
.sloth .name-tag .nt-name {
  color: #fff;
  font-size: 14px;
  font-weight: 700;
  letter-spacing: 0.3px;
}
.sloth .name-tag .nt-role {
  color: #f0a500;
  font-size: 11px;
  font-weight: 500;
  opacity: 0.9;
}

/* ===== Right Panel ===== */
.panel {
  width: 240px;
  background: linear-gradient(180deg, #16213e 0%, #111a2e 100%);
  border-left: 1px solid #1a3a5c;
  padding: 14px;
  overflow-y: auto;
  flex-shrink: 0;
  display: flex;
  flex-direction: column;
  gap: 10px;
  font-size: 13px;
}
.panel h2 {
  font-size: 14px;
  border-bottom: 1px solid #1a3a5c;
  padding-bottom: 8px;
  color: #f0a500;
  letter-spacing: 1px;
}
.panel .empty-msg {
  color: #556677;
  font-size: 12px;
  text-align: center;
  margin-top: 60px;
  line-height: 1.6;
}
.panel label {
  display: block;
  margin-bottom: 3px;
  color: #7a8fa0;
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.panel .value {
  font-size: 13px;
  color: #e8d5b7;
  margin-bottom: 8px;
}

/* Direction buttons */
.dir-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 4px;
  margin-bottom: 8px;
}
.dir-grid button {
  padding: 6px 0;
  background: #0d1525;
  color: #a0b0c0;
  border: 1px solid #1a3a5c;
  border-radius: 5px;
  cursor: pointer;
  font-size: 11px;
  transition: all .15s;
}
.dir-grid button:hover { background: #1a3a5c; color: #e8d5b7; }
.dir-grid button.active { background: #00e676; color: #111; border-color: #00e676; font-weight: 600; }

/* Scale */
.scale-row { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
.scale-row input[type=range] {
  flex: 1; accent-color: #f0a500;
  height: 4px; cursor: pointer;
}
.scale-row .scale-val {
  width: 42px; text-align: right; font-size: 12px;
  color: #f0a500; font-weight: 600;
}

/* Action buttons */
.action-row { display: flex; gap: 6px; margin-bottom: 6px; }
.action-row button {
  flex: 1; padding: 7px 0; border: 1px solid #1a3a5c; border-radius: 5px;
  background: #0d1525; color: #a0b0c0; cursor: pointer; font-size: 12px;
  transition: all .15s;
}
.action-row button:hover { background: #1a3a5c; color: #e8d5b7; }

.btn-delete { background: #3a1111 !important; border-color: #6b2020 !important; color: #ff6b6b !important; }
.btn-delete:hover { background: #5a1515 !important; color: #ff8888 !important; }

/* ===== Panel Tabs ===== */
.panel-tab {
  padding: 5px 14px; border: 1px solid #1a3a5c; border-radius: 5px;
  background: #0d1525; color: #667788; cursor: pointer; font-size: 12px;
  transition: all .15s; margin-right: 4px;
}
.panel-tab:hover { color: #a0b0c0; background: #1a2a3c; }
.panel-tab.active { background: #f0a50022; color: #f0a500; border-color: #f0a500; }

/* ===== Skill Pills ===== */
.skill-pill {
  display: inline-block; padding: 3px 10px; border-radius: 12px;
  font-size: 11px; font-weight: 600; border: 1px solid;
  white-space: nowrap;
}
.skill-pill:nth-child(6n+1) { background: #1a1a3a; color: #8888ff; border-color: #3333aa; }
.skill-pill:nth-child(6n+2) { background: #1a3a1a; color: #66cc66; border-color: #339933; }
.skill-pill:nth-child(6n+3) { background: #3a1a2a; color: #ff88aa; border-color: #aa3366; }
.skill-pill:nth-child(6n+4) { background: #3a2a1a; color: #ffaa44; border-color: #aa7733; }
.skill-pill:nth-child(6n+5) { background: #1a3a3a; color: #44cccc; border-color: #338888; }
.skill-pill:nth-child(6n+6) { background: #2a1a3a; color: #bb88ff; border-color: #773399; }

/* Task status badges */
.task-item { padding: 6px 0; border-bottom: 1px solid #111; font-size: 12px; }
.task-item:last-child { border-bottom: none; }
.task-badge {
  display: inline-block; padding: 1px 8px; border-radius: 8px; font-size: 10px; font-weight: 600;
}
.task-badge.pending { background: #333; color: #888; }
.task-badge.running { background: #f0a50033; color: #f0a500; animation: pulse 1.5s infinite; }
.task-badge.completed { background: #00e67633; color: #00e676; }
.task-badge.failed { background: #ff6b6b33; color: #ff6b6b; }
@keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: .5; } }

/* ===== Bottom Toolbar ===== */
.toolbar {
  display: flex; justify-content: center; gap: 10px; padding: 10px 16px;
  background: linear-gradient(180deg, #0f1a30 0%, #16213e 100%);
  border-top: 1px solid #1a3a5c;
  flex-shrink: 0; flex-wrap: wrap;
}
.toolbar button {
  padding: 8px 16px; background: #0d1525; color: #e8d5b7;
  border: 1px solid #1a3a5c; border-radius: 8px; cursor: pointer;
  font-size: 13px; transition: all .2s; white-space: nowrap;
}
.toolbar button:hover {
  background: #1a3a5c; border-color: #e8d5b7;
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(0,0,0,.3);
}
.toolbar .btn-accent {
  background: linear-gradient(135deg, #f0a500 0%, #e09000 100%);
  color: #111; border-color: #f0a500; font-weight: 600;
}
.toolbar .btn-accent:hover {
  background: linear-gradient(135deg, #ffb820 0%, #f0a500 100%);
  border-color: #ffcc44;
}
.toolbar .btn-reset {
  background: #1a1111; border-color: #4a2020; color: #cc8888;
}
.toolbar .btn-reset:hover { background: #2a1515; border-color: #6a3030; color: #ff9999; }

/* ===== Modal Overlay ===== */
.modal-overlay {
  display: none;
  position: fixed; inset: 0;
  background: rgba(0,0,0,.7);
  backdrop-filter: blur(4px);
  z-index: 9999;
  align-items: center; justify-content: center;
}
.modal-overlay.active { display: flex; }

.modal {
  background: linear-gradient(180deg, #1a2440 0%, #141c30 100%);
  border: 1px solid #2a4a6c;
  border-radius: 14px;
  padding: 24px;
  min-width: 360px;
  max-width: 90vw;
  max-height: 80vh;
  overflow-y: auto;
  box-shadow: 0 20px 60px rgba(0,0,0,.5);
  animation: modalIn .2s ease-out;
}
@keyframes modalIn {
  from { opacity: 0; transform: scale(.95) translateY(10px); }
  to { opacity: 1; transform: scale(1) translateY(0); }
}
.modal h3 {
  font-size: 16px; margin-bottom: 16px;
  color: #f0a500; letter-spacing: 1px;
}
.modal .close-btn {
  float: right; background: none; border: none;
  color: #556677; font-size: 20px; cursor: pointer;
  padding: 0 4px; line-height: 1;
}
.modal .close-btn:hover { color: #e8d5b7; }

/* Character Picker Grid */
.picker-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 10px;
}
.picker-item {
  display: flex; flex-direction: column; align-items: center;
  padding: 10px 6px 8px;
  background: #0d1525;
  border: 2px solid transparent;
  border-radius: 10px;
  cursor: pointer;
  transition: all .15s;
}
.picker-item:hover {
  border-color: #f0a500;
  background: #162035;
  transform: translateY(-2px);
}
.picker-item img {
  width: 56px; height: 56px; object-fit: contain;
  margin-bottom: 6px;
  filter: drop-shadow(0 2px 4px rgba(0,0,0,.4));
}
.picker-item .p-name {
  font-size: 11px; font-weight: 600; color: #e8d5b7;
}
.picker-item .p-role {
  font-size: 9px; color: #7a8fa0; margin-top: 2px;
}

/* New Office Modal */
.new-office-modal label {
  color: #7a8fa0; font-size: 12px; margin-bottom: 6px; display: block;
}
.new-office-modal input[type=text],
.new-office-modal textarea {
  width: 100%;
  padding: 10px 14px;
  background: #0d1525;
  border: 1px solid #1a3a5c;
  border-radius: 8px;
  color: #e8d5b7;
  font-size: 13px;
  margin-bottom: 12px;
  outline: none;
  font-family: inherit;
}
.new-office-modal input:focus,
.new-office-modal textarea:focus { border-color: #f0a500; }
.new-office-modal input::placeholder,
.new-office-modal textarea::placeholder { color: #445566; }
.new-office-modal .hint {
  font-size: 11px; color: #445566; margin: -8px 0 12px; line-height: 1.5;
}
.new-office-modal .option-group {
  display: flex; gap: 8px; margin-bottom: 14px;
}
.new-office-modal .option-btn {
  flex: 1; padding: 10px;
  background: #0d1525; border: 1px solid #1a3a5c;
  border-radius: 8px; color: #a0b0c0;
  cursor: pointer; font-size: 12px; text-align: center;
  transition: all .15s;
}
.new-office-modal .option-btn:hover { border-color: #7a8fa0; color: #e8d5b7; }
.new-office-modal .option-btn.selected { border-color: #f0a500; color: #f0a500; background: rgba(240,165,0,.08); }
.new-office-modal .submit-btn {
  width: 100%;
  padding: 10px;
  background: linear-gradient(135deg, #f0a500 0%, #e09000 100%);
  color: #111;
  border: none;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all .15s;
}
.new-office-modal .submit-btn:hover {
  background: linear-gradient(135deg, #ffb820 0%, #f0a500 100%);
}

/* AI Loading Spinner */
.ai-loading {
  display: none;
  text-align: center;
  padding: 30px 0;
  color: #7a8fa0;
}
.ai-loading.active { display: block; }
.spinner {
  width: 36px; height: 36px;
  border: 3px solid #1a3a5c;
  border-top-color: #f0a500;
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  margin: 0 auto 12px;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* Tab context menu */
.ctx-menu {
  position: fixed;
  background: #1a2440;
  border: 1px solid #2a4a6c;
  border-radius: 8px;
  padding: 4px 0;
  z-index: 10000;
  min-width: 140px;
  box-shadow: 0 8px 24px rgba(0,0,0,.5);
  animation: modalIn .12s ease-out;
}
.ctx-menu button {
  display: block; width: 100%;
  padding: 8px 16px;
  background: none; border: none;
  color: #a0b0c0; font-size: 12px;
  cursor: pointer; text-align: left;
  transition: all .1s;
}
.ctx-menu button:hover { background: rgba(255,255,255,.06); color: #e8d5b7; }
.ctx-menu .ctx-danger:hover { background: rgba(255,80,80,.12); color: #ff6b6b; }

/* Tab rename input */
.tab-rename {
  background: #0d1525;
  border: 1px solid #f0a500;
  border-radius: 4px;
  color: #e8d5b7;
  font-size: 12px;
  padding: 2px 6px;
  width: 100px;
  outline: none;
}

/* Scrollbar */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: #2a3a5c; border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: #3a5a8c; }

/* ===== LIVE Animation Features ===== */

/* Live Badge */
.live-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  background: rgba(255,82,82,0.15);
  border: 1px solid rgba(255,82,82,0.3);
  border-radius: 20px;
  padding: 4px 14px;
  font-size: 12px;
  font-weight: 600;
  color: #ff5252;
  letter-spacing: 1px;
  position: absolute;
  left: 16px;
  top: 8px;
  cursor: pointer;
  transition: all 0.3s;
}
.live-badge.connected { background: rgba(0,230,118,0.15); border-color: rgba(0,230,118,0.3); color: #00e676; }
.live-dot {
  width: 8px; height: 8px;
  background: #ff5252;
  border-radius: 50%;
  animation: livePulse 1.5s ease-in-out infinite;
}
.live-badge.connected .live-dot { background: #00e676; }
@keyframes livePulse {
  0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(255,82,82,0.6); }
  50% { opacity: 0.7; box-shadow: 0 0 0 6px rgba(255,82,82,0); }
}

/* Status Dot on Sloths */
.sloth .status-dot {
  position: absolute;
  top: -4px;
  right: -4px;
  width: 12px; height: 12px;
  border-radius: 50%;
  border: 2px solid rgba(0,0,0,0.4);
  background: #00e676;
  transition: background 0.3s;
  z-index: 10;
  pointer-events: none;
}
.sloth .status-dot.thinking {
  background: #ffc107;
  box-shadow: 0 0 8px #ffc107, 0 0 16px rgba(255,193,7,0.4);
  animation: statusPulse 1s ease-in-out infinite;
}
.sloth .status-dot.busy {
  background: #ff5252;
  box-shadow: 0 0 8px #ff5252, 0 0 16px rgba(255,82,82,0.4);
  animation: statusPulse 0.6s ease-in-out infinite;
}
@keyframes statusPulse {
  0%, 100% { transform: scale(1); opacity: 1; }
  50% { transform: scale(1.4); opacity: 0.7; }
}

/* Task Queue Badge */
.sloth .queue-badge {
  position: absolute;
  top: -8px;
  left: -8px;
  min-width: 22px; height: 22px;
  border-radius: 11px;
  background: #e53935;
  color: #fff;
  font-size: 11px;
  font-weight: 700;
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 15;
  border: 2px solid rgba(0,0,0,0.4);
  box-shadow: 0 0 8px rgba(229,57,53,0.5);
  animation: badgeBounce 0.4s ease-out;
  padding: 0 4px;
}
.sloth .queue-badge.active { display: flex; }
@keyframes badgeBounce {
  0% { transform: scale(0); }
  50% { transform: scale(1.3); }
  100% { transform: scale(1); }
}

/* Thinking dots animation */
.thinking-dots::after {
  content: '';
  animation: dots 1.5s steps(4, end) infinite;
}
@keyframes dots {
  0% { content: ''; }
  25% { content: '.'; }
  50% { content: '..'; }
  75% { content: '...'; }
}

/* Chat Bubble */
.sloth .chat-bubble {
  position: absolute;
  bottom: calc(100% + 12px);
  left: 50%;
  transform: translateX(-50%) scale(0);
  background: rgba(255,255,255,0.95);
  color: #1a1a2e;
  padding: 8px 14px;
  border-radius: 12px;
  border-bottom-left-radius: 4px;
  font-size: 13px;
  font-weight: 500;
  white-space: nowrap;
  max-width: 220px;
  overflow: hidden;
  text-overflow: ellipsis;
  box-shadow: 0 4px 20px rgba(0,0,0,0.3), 0 0 0 1px rgba(255,255,255,0.1);
  z-index: 100;
  pointer-events: none;
  animation: bubbleLife 4s ease forwards;
}
.sloth .chat-bubble::after {
  content: '';
  position: absolute;
  bottom: -6px;
  left: 16px;
  width: 12px; height: 12px;
  background: rgba(255,255,255,0.95);
  clip-path: polygon(0 0, 100% 0, 0 100%);
}
.sloth .chat-bubble.processing {
  background: rgba(255,193,7,0.3);
  color: #fff;
  border: 1px solid rgba(255,193,7,0.6);
  box-shadow: 0 4px 20px rgba(255,193,7,0.3);
  font-weight: 600;
}
.sloth .chat-bubble.processing::after { background: rgba(255,193,7,0.3); }
.sloth .chat-bubble.success {
  background: rgba(0,230,118,0.15);
  color: #00e676;
  border: 1px solid rgba(0,230,118,0.3);
}
.sloth .chat-bubble.success::after { background: rgba(0,230,118,0.15); }
.live-spinner {
  display: inline-block;
  width: 12px; height: 12px;
  border: 2px solid #ffc107;
  border-top-color: transparent;
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  vertical-align: middle;
  margin-right: 4px;
}
@keyframes bubbleLife {
  0% { transform: translateX(-50%) scale(0); opacity: 0; }
  8% { transform: translateX(-50%) scale(1.08); opacity: 1; }
  12% { transform: translateX(-50%) scale(1); opacity: 1; }
  75% { transform: translateX(-50%) scale(1) translateY(0); opacity: 1; }
  85% { transform: translateX(-50%) scale(1) translateY(-4px); opacity: 0.8; }
  100% { transform: translateX(-50%) scale(0.9) translateY(-8px); opacity: 0; }
}

/* Envelope */
.envelope {
  position: absolute;
  z-index: 200;
  pointer-events: none;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 2px;
}
.envelope-icon {
  font-size: 96px;
  filter: drop-shadow(0 8px 32px rgba(240,165,0,1)) drop-shadow(0 0 48px rgba(240,165,0,0.8));
  animation: envelopeWobble 0.25s ease-in-out infinite alternate;
  transform-origin: center;
}
.envelope-label {
  font-size: 16px;
  font-weight: 700;
  color: #f0a500;
  background: rgba(10,10,26,0.95);
  padding: 6px 16px;
  border-radius: 12px;
  white-space: nowrap;
  max-width: 200px;
  overflow: hidden;
  text-overflow: ellipsis;
  border: 2px solid rgba(240,165,0,0.5);
  box-shadow: 0 4px 12px rgba(0,0,0,0.4);
}
@keyframes envelopeWobble {
  from { transform: rotate(-12deg) translateY(-6px) scale(1.1); }
  to { transform: rotate(12deg) translateY(6px) scale(0.9); }
}

/* Activity Log Panel (bottom-right, collapsible) */
.log-panel {
  position: fixed;
  bottom: 60px;
  right: 16px;
  width: 320px;
  max-height: 240px;
  background: linear-gradient(180deg, #16213e, #0a0a1a);
  border: 1px solid #1a3a5c;
  border-radius: 12px;
  box-shadow: 0 8px 32px rgba(0,0,0,.5);
  z-index: 9998;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  transition: max-height 0.3s, opacity 0.3s;
}
.log-panel.collapsed { max-height: 36px; }
.log-panel-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 8px 14px;
  cursor: pointer;
  flex-shrink: 0;
  border-bottom: 1px solid #1a3a5c;
}
.log-panel-header h3 {
  font-size: 12px;
  color: #667788;
  margin: 0;
}
.log-panel-header .toggle-icon {
  font-size: 14px;
  color: #667788;
  transition: transform 0.3s;
}
.log-panel.collapsed .toggle-icon { transform: rotate(180deg); }
.log-entries {
  flex: 1;
  overflow-y: auto;
  padding: 6px 14px;
  display: flex;
  flex-direction: column;
  gap: 3px;
}
.log-entries::-webkit-scrollbar { width: 5px; }
.log-entries::-webkit-scrollbar-track { background: transparent; }
.log-entries::-webkit-scrollbar-thumb { background: #1a3a5c; border-radius: 3px; }
.log-entry {
  font-size: 12px;
  color: #667788;
  line-height: 1.5;
  animation: logSlideIn 0.3s ease;
}
.log-entry .time { color: #445566; margin-right: 8px; font-size: 11px; }
.log-entry .agent-name { color: #f0a500; font-weight: 600; }
.log-entry .action { color: #e8d5b7; }
@keyframes logSlideIn {
  from { opacity: 0; transform: translateY(8px); }
  to { opacity: 1; transform: translateY(0); }
}

/* ===== Cost Counter (floating) ===== */
.cost-counter {
  position: fixed;
  top: 12px;
  right: 60px;
  background: linear-gradient(135deg, rgba(240,165,0,0.15), rgba(240,165,0,0.05));
  border: 1px solid rgba(240,165,0,0.3);
  border-radius: 20px;
  padding: 6px 18px;
  cursor: pointer;
  z-index: 9999;
  display: flex;
  align-items: center;
  gap: 8px;
  transition: all 0.3s;
  font-size: 14px;
  font-weight: 700;
  color: #f0a500;
}
.cost-counter:hover {
  background: linear-gradient(135deg, rgba(240,165,0,0.25), rgba(240,165,0,0.1));
  transform: translateY(-1px);
  box-shadow: 0 4px 16px rgba(240,165,0,0.2);
}

/* ===== Cost Dashboard Modal ===== */
.cost-modal-overlay {
  display: none;
  position: fixed; inset: 0;
  background: rgba(0,0,0,.85);
  backdrop-filter: blur(8px);
  z-index: 10001;
  overflow-y: auto;
}
.cost-modal-overlay.active { display: block; }
.cost-modal {
  max-width: 900px;
  margin: 40px auto;
  padding: 32px;
  animation: modalIn .3s ease-out;
}
.cost-modal .close-btn {
  position: fixed; top: 16px; right: 24px;
  background: none; border: none; color: #667788;
  font-size: 28px; cursor: pointer; z-index: 10002;
}
.cost-modal .close-btn:hover { color: #e8d5b7; }
.cost-cards {
  display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 28px;
}
.cost-card {
  background: #0d1525; border: 1px solid #1a3a5c; border-radius: 12px;
  padding: 20px; text-align: center;
}
.cost-card .big { font-size: 28px; font-weight: 700; color: #f0a500; }
.cost-card .label { font-size: 12px; color: #556677; margin-top: 4px; }
.cost-table {
  width: 100%; border-collapse: collapse; font-size: 13px; margin-bottom: 24px;
}
.cost-table th { text-align: left; padding: 10px; color: #556677; border-bottom: 1px solid #1a3a5c; }
.cost-table td { padding: 10px; border-bottom: 1px solid #0d1525; color: #e8d5b7; }
.cost-table tr:hover td { background: rgba(240,165,0,0.04); }
.cost-chart-wrap {
  background: #0d1525; border: 1px solid #1a3a5c; border-radius: 12px;
  padding: 20px; margin-bottom: 24px;
}
.cost-chart { display: flex; align-items: flex-end; gap: 8px; height: 140px; }
.cost-bar-col { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 4px; height: 100%; justify-content: flex-end; }
.cost-bar { width: 100%; background: linear-gradient(180deg, #f0a500, #e09000); border-radius: 4px 4px 0 0; min-height: 2px; transition: height .5s; }
.cost-bar-label { font-size: 10px; color: #556677; }
.cost-bar-val { font-size: 10px; color: #f0a500; font-weight: 600; }
.fun-metrics { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
.fun-card {
  background: #0d1525; border: 1px solid #1a3a5c; border-radius: 10px;
  padding: 16px; font-size: 13px; color: #99aabb;
}
.fun-card .fun-icon { font-size: 20px; margin-bottom: 6px; }
.fun-card .fun-val { font-size: 16px; font-weight: 700; color: #e8d5b7; }
/* Dashboard tabs */
.dash-tabs { display: flex; gap: 0; margin-bottom: 20px; border-bottom: 2px solid #1a3a5c; }
.dash-tab { padding: 10px 20px; cursor: pointer; color: #556677; font-size: 14px; font-weight: 600; border-bottom: 2px solid transparent; margin-bottom: -2px; transition: all .2s; }
.dash-tab:hover { color: #99aabb; }
.dash-tab.active { color: #f0a500; border-bottom-color: #f0a500; }
.dash-panel { display: none; }
.dash-panel.active { display: block; }

/* Agent thought cards */
.thought-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 16px; }
.thought-card {
  background: #0d1525; border: 1px solid #1a3a5c; border-radius: 12px;
  padding: 16px; position: relative; overflow: hidden;
}
.thought-card::before {
  content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px;
  background: linear-gradient(90deg, #f0a500, #e09000);
}
.thought-avatar { width: 48px; height: 48px; border-radius: 50%; object-fit: contain; image-rendering: pixelated; border: 2px solid #1a3a5c; }
.thought-bubble {
  background: #111d33; border: 1px solid #1a3a5c; border-radius: 12px;
  padding: 10px 14px; margin-top: 10px; font-size: 13px; color: #e8d5b7;
  line-height: 1.5; position: relative; font-style: italic;
}
.thought-bubble::before {
  content: 'ğŸ’­'; position: absolute; top: -10px; right: 10px; font-size: 16px;
}
.thought-stats { display: flex; gap: 12px; margin-top: 10px; flex-wrap: wrap; }
.thought-stat { font-size: 11px; color: #556677; }
.thought-stat span { color: #f0a500; font-weight: 600; }

/* Engagement stats */
.engage-cards { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px; }
.engage-card { background: #0d1525; border: 1px solid #1a3a5c; border-radius: 12px; padding: 18px; text-align: center; }
.engage-card .big { font-size: 24px; font-weight: 700; color: #4ecdc4; }
.engage-card .label { font-size: 11px; color: #556677; margin-top: 4px; }

/* Salary inline edit */
.salary-edit {
  background: #0d1525; border: 1px solid #f0a500; border-radius: 4px;
  color: #f0a500; font-size: 13px; padding: 2px 6px; width: 80px; outline: none;
}

/* Mobile-only elements hidden on desktop */
.mobile-log-area, .mobile-toolbar-toggle { display: none; }

/* Responsive */
@media (max-width: 768px) {
  body { overflow: hidden; height: 100vh; display: flex; flex-direction: column; }
  header h1 { font-size: 16px; }
  .tab-bar { padding: 0 8px; }
  .main { flex-direction: column; overflow: hidden; flex: 1; }
  .canvas-wrap {
    padding: 0;
    min-height: 0;
    flex: 0 0 auto;
  }
  .canvas {
    border-radius: 0;
    max-height: none;
    width: 100%;
  }
  /* Mobile: Activity Log fills remaining space below canvas */
  .mobile-log-area {
    display: block !important;
    flex: 1;
    overflow-y: auto;
    background: #0a0f1a;
    padding: 8px 12px;
    font-size: 12px;
  }
  .mobile-log-area .log-entry {
    padding: 4px 0;
    border-bottom: 1px solid rgba(255,255,255,.05);
    color: #99aabb;
  }
  .mobile-log-area .time { color: #556677; margin-right: 6px; }
  .mobile-log-area .agent-name { color: #f0a500; font-weight: 600; }
  .panel {
    width: 100%;
    display: none;
  }
  .panel.mobile-show { display: flex; }
  /* Toolbar: collapsed by default on mobile */
  .toolbar { 
    display: none; 
    flex-wrap: wrap; gap: 6px; padding: 8px;
    background: #111a2e;
    border-top: 1px solid #1a3a5c;
  }
  .toolbar.mobile-show { display: flex; }
  .mobile-toolbar-toggle {
    display: flex !important;
    align-items: center;
    justify-content: center;
    padding: 8px;
    background: #111a2e;
    border-top: 1px solid #1a3a5c;
    color: #99aabb;
    font-size: 12px;
    cursor: pointer;
  }
  .toolbar button { font-size: 12px; padding: 6px 12px; }
  .picker-grid { grid-template-columns: repeat(2, 1fr); }
  .log-panel { display: none !important; }
  .sloth .name-tag { font-size: 12px; }
  .sloth .name-tag .nt-name { font-size: 12px; }
  .sloth .name-tag .nt-role { font-size: 9px; }
}
</style>
</head>
<body>

<header>
  <h1>å·æ‡¶è¾¦å…¬å®¤ â€” <span>Lazy Office</span></h1>
  <div class="live-badge" id="liveBadge" onclick="toggleLogPanel()" title="SSE é€£ç·šç‹€æ…‹"><div class="live-dot"></div><span id="liveLabel">OFFLINE</span></div>
  <div id="notifBell" style="position:absolute;right:16px;top:8px;cursor:pointer;font-size:20px;display:none" onclick="toggleNotifPanel()">
    ğŸ”” <span id="notifBadge" style="background:#e53935;color:#fff;font-size:10px;padding:1px 5px;border-radius:8px;position:relative;top:-8px;display:none">0</span>
  </div>
  <div style="display:flex;justify-content:center;gap:12px;padding:8px 0 4px;font-size:12px;">
    <a href="/security.html" style="color:#99aabb;text-decoration:none;padding:4px 12px;border-radius:6px;transition:all .2s;" onmouseover="this.style.background='rgba(240,165,0,.1)';this.style.color='#f0a500'" onmouseout="this.style.background='transparent';this.style.color='#99aabb'">ğŸ”’ å®‰å…¨è¨­å®š</a>
    <a href="/agents-config.html" style="color:#99aabb;text-decoration:none;padding:4px 12px;border-radius:6px;transition:all .2s;" onmouseover="this.style.background='rgba(240,165,0,.1)';this.style.color='#f0a500'" onmouseout="this.style.background='transparent';this.style.color='#99aabb'">ğŸ¤– å“¡å·¥è¨­å®š</a>
    <a href="/skills.html" style="color:#99aabb;text-decoration:none;padding:4px 12px;border-radius:6px;transition:all .2s;" onmouseover="this.style.background='rgba(240,165,0,.1)';this.style.color='#f0a500'" onmouseout="this.style.background='transparent';this.style.color='#99aabb'">ğŸ¯ Skills</a>
  </div>
</header>

<!-- Cost Counter -->
<div class="cost-counter" id="costCounter" onclick="openCostDashboard()">
  ğŸ’° å·²çœä¸‹ NT$ <span id="costCounterValue">0</span>
</div>

<!-- Cost Dashboard Modal -->
<div class="cost-modal-overlay" id="costDashboardModal">
  <div class="cost-modal">
    <button class="close-btn" onclick="closeCostDashboard()">&times;</button>
    <h2 style="color:#f0a500;margin-bottom:16px;font-size:22px">ğŸ“Š AI åœ˜éšŠå„€è¡¨æ¿</h2>
    <div class="dash-tabs">
      <div class="dash-tab active" data-panel="costPanel" onclick="switchDashTab(this)">ğŸ’° æˆæœ¬ç¯€çœ</div>
      <div class="dash-tab" data-panel="engagePanel" onclick="switchDashTab(this)">ğŸ’¬ äº’å‹•çµ±è¨ˆ</div>
      <div class="dash-tab" data-panel="thoughtPanel" onclick="switchDashTab(this)">ğŸ§  å“¡å·¥å¿ƒè²</div>
    </div>

    <!-- Cost Panel -->
    <div class="dash-panel active" id="costPanel">
      <div class="cost-cards" id="costCards"></div>
      <h3 style="color:#e8d5b7;margin-bottom:12px;font-size:15px">ğŸ† å“¡å·¥æ’è¡Œæ¦œ</h3>
      <table class="cost-table"><thead><tr><th>å“¡å·¥</th><th>ä»»å‹™</th><th>æ’ç¨‹</th><th>ç›£æ§</th><th>ç¯€çœé‡‘é¡</th><th>å·¥æ™‚</th><th>æœˆè–ª</th></tr></thead><tbody id="costTableBody"></tbody></table>
      <h3 style="color:#e8d5b7;margin-bottom:12px;font-size:15px">ğŸ“ˆ æœ€è¿‘ 7 å¤©è¶¨å‹¢</h3>
      <div class="cost-chart-wrap"><div class="cost-chart" id="costChart"></div></div>
      <h3 style="color:#e8d5b7;margin-bottom:12px;font-size:15px">ğŸ¯ æœ‰è¶£æŒ‡æ¨™</h3>
      <div class="fun-metrics" id="funMetrics"></div>
    </div>

    <!-- Engagement Panel -->
    <div class="dash-panel" id="engagePanel">
      <div class="engage-cards" id="engageCards"></div>
      <div id="realUsageSection" style="margin-bottom:20px"></div>
      <h3 style="color:#e8d5b7;margin-bottom:12px;font-size:15px">ğŸ“Š å„å“¡å·¥ä»Šæ—¥äº’å‹•</h3>
      <table class="cost-table"><thead><tr><th>å“¡å·¥</th><th>ğŸ’¬ å°è©±</th><th>ğŸ”¤ Token (å¯¦éš›)</th><th>ğŸ’µ API èŠ±è²»</th><th>âœ… å®Œæˆ</th></tr></thead><tbody id="engageTableBody"></tbody></table>
      <h3 style="color:#e8d5b7;margin-bottom:12px;font-size:15px">ğŸ“ˆ æœ¬é€±è¶¨å‹¢</h3>
      <div class="cost-chart-wrap"><div class="cost-chart" id="engageChart"></div></div>
    </div>

    <!-- Thought Panel -->
    <div class="dash-panel" id="thoughtPanel">
      <p style="color:#556677;font-size:13px;margin-bottom:16px">ğŸ”® å·è½ä¸€ä¸‹ AI å“¡å·¥å€‘åœ¨æƒ³ä»€éº¼...</p>
      <div class="thought-grid" id="thoughtGrid"></div>
    </div>
  </div>
</div>

<!-- Notification Panel -->
<div id="notifPanel" style="display:none;position:fixed;right:16px;top:50px;width:320px;max-height:400px;overflow-y:auto;background:#16213e;border:1px solid #1a3a5c;border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,.5);z-index:99999;padding:12px">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
    <span style="font-size:14px;font-weight:600;color:#e8d5b7">é€šçŸ¥</span>
    <button onclick="clearNotifs()" style="background:none;border:none;color:#556677;cursor:pointer;font-size:11px">æ¸…é™¤å…¨éƒ¨</button>
  </div>
  <div id="notifList" style="font-size:13px"></div>
</div>

<!-- Office Tabs -->
<div class="tab-bar" id="tabBar"></div>

<div class="main">
  <div class="canvas-wrap">
    <div class="canvas" id="canvas"></div>
  </div>

  <div class="panel" id="panel">
    <h2>å±¬æ€§é¢æ¿</h2>
    <div class="empty-msg" id="panelEmpty">é»é¸æ¨¹æ‡¶ä»¥ç·¨è¼¯å±¬æ€§<br><br>æ‹–æ›³ç§»å‹•ä½ç½®<br>å³å´é¢æ¿èª¿æ•´æ–¹å‘èˆ‡å¤§å°</div>
    <!-- Tab switcher for detail/edit -->
    <div id="panelTabs" style="display:none;margin-bottom:10px">
      <button class="panel-tab active" data-tab="detail" onclick="switchPanelTab('detail')">ğŸ‘¤ è©³æƒ…</button>
      <button class="panel-tab" data-tab="edit" onclick="switchPanelTab('edit')">âœï¸ ç·¨è¼¯</button>
    </div>

    <!-- Agent Detail Panel -->
    <div id="panelDetail" style="display:none">
      <div style="text-align:center;margin-bottom:12px">
        <img id="detailAvatar" src="" style="width:120px;height:120px;object-fit:contain;image-rendering:pixelated;border-radius:8px;border:2px solid #1a3a5c">
      </div>
      <div style="text-align:center;margin-bottom:8px">
        <span id="detailName" style="font-size:18px;font-weight:700;color:#e8d5b7"></span>
        <span id="detailRole" style="display:inline-block;margin-left:8px;padding:2px 10px;border-radius:10px;background:#f0a50033;color:#f0a500;font-size:12px"></span>
      </div>
      <div id="detailDesc" style="font-size:13px;color:#99aabb;line-height:1.5;margin-bottom:12px;padding:8px;background:#0d1525;border-radius:6px"></div>

      <div style="margin-bottom:10px">
        <label style="font-size:11px;color:#556677;text-transform:uppercase;letter-spacing:1px">ğŸ’° æœˆè–ª</label>
        <div id="detailSalary" style="font-size:14px;color:#f0a500;padding:4px 0;cursor:pointer" onclick="startSalaryEdit()">NT$ 30,000</div>
      </div>

      <label style="font-size:11px;color:#556677;text-transform:uppercase;letter-spacing:1px">ğŸ›  Skills</label>
      <div id="detailSkills" style="display:flex;flex-wrap:wrap;gap:6px;margin:6px 0 14px"></div>

      <label style="font-size:11px;color:#556677;text-transform:uppercase;letter-spacing:1px">ğŸ“‹ ä»Šæ—¥ä»»å‹™</label>
      <div id="detailTasks" style="margin:6px 0 14px;font-size:13px"></div>

      <label style="font-size:11px;color:#556677;text-transform:uppercase;letter-spacing:1px">ğŸ“Š çµ±è¨ˆ</label>
      <div id="detailStats" style="display:flex;gap:10px;margin-top:6px;flex-wrap:wrap">
        <div style="text-align:center;flex:1;padding:8px;background:#0d1525;border-radius:6px;min-width:60px">
          <div id="statToday" style="font-size:20px;font-weight:700;color:#f0a500">0</div>
          <div style="font-size:11px;color:#556677">ä»Šæ—¥å®Œæˆ</div>
        </div>
        <div style="text-align:center;flex:1;padding:8px;background:#0d1525;border-radius:6px;min-width:60px">
          <div id="statWeek" style="font-size:20px;font-weight:700;color:#f0a500">0</div>
          <div style="font-size:11px;color:#556677">æœ¬é€±å®Œæˆ</div>
        </div>
        <div style="text-align:center;flex:1;padding:8px;background:#0d1525;border-radius:6px;min-width:60px">
          <div id="statMonthSavings" style="font-size:16px;font-weight:700;color:#f0a500">$0</div>
          <div style="font-size:11px;color:#556677">æœ¬æœˆç¯€çœ</div>
        </div>
      </div>
    </div>

    <!-- Edit Panel (original) -->
    <div id="panelContent" style="display:none">
      <label>åç¨±</label>
      <div class="value" id="propName">â€”</div>

      <label>è§’è‰²</label>
      <div class="value" id="propRole">â€”</div>

      <label>ä½ç½®</label>
      <div class="value" id="propPos">â€”</div>

      <label>æ–¹å‘</label>
      <div class="dir-grid" id="dirGroup">
        <button data-dir="sw">â†™ å·¦å‰</button>
        <button data-dir="se">â†˜ å³å‰</button>
        <button data-dir="nw">â†– å·¦å¾Œ</button>
        <button data-dir="ne">â†— å³å¾Œ</button>
      </div>

      <label>ç¸®æ”¾</label>
      <div class="scale-row">
        <input type="range" id="scaleSlider" min="30" max="200" value="100">
        <span class="scale-val" id="scaleVal">100%</span>
      </div>

      <label>åœ–å±¤</label>
      <div class="action-row">
        <button id="btnZUp">ä¸Šç§»ä¸€å±¤</button>
        <button id="btnZDown">ä¸‹ç§»ä¸€å±¤</button>
      </div>

      <div class="action-row" style="margin-top:10px">
        <button class="btn-delete" id="btnDelete">åˆªé™¤</button>
      </div>
    </div>
  </div>
</div>

<!-- Security Dashboard -->
<div id="securityDashboard" style="display:none;padding:24px;max-width:1200px;margin:0 auto;width:100%">
  <div style="display:flex;align-items:center;gap:16px;margin-bottom:24px">
    <h2 style="margin:0;color:#e8d5b7;font-size:22px">ğŸ›¡ å®‰å…¨å„€è¡¨æ¿</h2>
    <button onclick="runSecurityScan()" style="padding:6px 16px;background:#1a5c3a;border:1px solid #2a8c5a;color:#e8d5b7;border-radius:6px;cursor:pointer;font-size:13px">ğŸ”„ ç«‹å³æƒæ</button>
  </div>

  <!-- Health Score -->
  <div style="display:flex;gap:20px;margin-bottom:24px;flex-wrap:wrap">
    <div style="background:#0d1525;border-radius:12px;padding:24px;text-align:center;min-width:160px;border:1px solid #1a3a5c">
      <div id="secHealthDot" style="width:64px;height:64px;border-radius:50%;margin:0 auto 12px;background:#2ecc71;box-shadow:0 0 20px #2ecc7155"></div>
      <div id="secScore" style="font-size:36px;font-weight:700;color:#f0a500">100</div>
      <div style="font-size:12px;color:#556677">ç³»çµ±å¥åº·åº¦</div>
    </div>

    <!-- Stats -->
    <div style="display:flex;gap:16px;flex:1;flex-wrap:wrap">
      <div style="background:#0d1525;border-radius:12px;padding:20px;flex:1;min-width:120px;border:1px solid #1a3a5c;text-align:center">
        <div id="statScansToday" style="font-size:28px;font-weight:700;color:#f0a500">0</div>
        <div style="font-size:11px;color:#556677">ä»Šæ—¥æƒæ</div>
      </div>
      <div onclick="scrollToSecSection('secPromptSection')" style="background:#0d1525;border-radius:12px;padding:20px;flex:1;min-width:120px;border:1px solid #1a3a5c;text-align:center;cursor:pointer;transition:border-color .2s" onmouseenter="this.style.borderColor='#e74c3c'" onmouseleave="this.style.borderColor='#1a3a5c'">
        <div id="statThreatsToday" style="font-size:28px;font-weight:700;color:#e74c3c">0</div>
        <div style="font-size:11px;color:#556677">åµæ¸¬å¨è„… â†“</div>
      </div>
      <div onclick="scrollToSecSection('secBlockSection')" style="background:#0d1525;border-radius:12px;padding:20px;flex:1;min-width:120px;border:1px solid #1a3a5c;text-align:center;cursor:pointer;transition:border-color .2s" onmouseenter="this.style.borderColor='#e67e22'" onmouseleave="this.style.borderColor='#1a3a5c'">
        <div id="statBlocksToday" style="font-size:28px;font-weight:700;color:#e67e22">0</div>
        <div style="font-size:11px;color:#556677">å·²é˜»æ“‹ â†“</div>
      </div>
    </div>
  </div>

  <!-- Port Scan Results -->
  <div style="background:#0d1525;border-radius:12px;padding:20px;margin-bottom:20px;border:1px solid #1a3a5c">
    <h3 style="margin:0 0 12px;color:#e8d5b7;font-size:15px">ğŸ”’ Port æƒæ</h3>
    <div style="max-height:300px;overflow-y:auto;border-radius:6px">
    <table style="width:100%;border-collapse:collapse;font-size:13px">
      <thead><tr style="color:#556677;text-align:left;border-bottom:1px solid #1a3a5c">
        <th style="padding:8px">Port</th><th style="padding:8px">æœå‹™</th><th style="padding:8px">ä½å€</th><th style="padding:8px">ç‹€æ…‹</th>
      </tr></thead>
      <tbody id="secPortTable"></tbody>
    </table>
    </div>
    <div id="secPortEmpty" style="color:#556677;font-size:12px;padding:12px;text-align:center">å°šæœªæƒæ</div>
  </div>

  <!-- Prompt Review Log (threats) -->
  <div id="secPromptSection"></div>
  <div style="background:#0d1525;border-radius:12px;padding:20px;margin-bottom:20px;border:1px solid #1a3a5c">
    <h3 style="margin:0 0 12px;color:#e8d5b7;font-size:15px">ğŸ›¡ Prompt å¯©æŸ¥ Log</h3>
    <div style="margin-bottom:12px;display:flex;gap:8px">
      <input id="secPromptInput" type="text" placeholder="æ¸¬è©¦ prompt injection..." style="flex:1;padding:8px 12px;background:#162035;border:1px solid #1a3a5c;color:#e8d5b7;border-radius:6px;font-size:13px">
      <button onclick="testPromptInjection()" style="padding:8px 16px;background:#4a148c;border:1px solid #6a1b9a;color:#e8d5b7;border-radius:6px;cursor:pointer;font-size:13px">æª¢æ¸¬</button>
    </div>
    <table style="width:100%;border-collapse:collapse;font-size:13px">
      <thead><tr style="color:#556677;text-align:left;border-bottom:1px solid #1a3a5c">
        <th style="padding:8px">æ™‚é–“</th><th style="padding:8px">ä¾†æº</th><th style="padding:8px">è¨Šæ¯</th><th style="padding:8px">å¨è„…</th><th style="padding:8px">è™•ç†</th>
      </tr></thead>
      <tbody id="secPromptTable"></tbody>
    </table>
    <div id="secPromptEmpty" style="color:#556677;font-size:12px;padding:12px;text-align:center">æš«ç„¡ç´€éŒ„</div>
  </div>

  <!-- Blocked / Recent Alerts -->
  <div id="secBlockSection"></div>
  <div style="background:#0d1525;border-radius:12px;padding:20px;border:1px solid #1a3a5c">
    <h3 style="margin:0 0 12px;color:#e8d5b7;font-size:15px">âš ï¸ æœ€è¿‘è­¦å ±</h3>
    <div id="secAlerts" style="font-size:13px;color:#99aabb">æš«ç„¡è­¦å ±</div>
  </div>
</div>

<!-- Mobile: Log area fills space below canvas -->
<div class="mobile-log-area" id="mobileLogArea"><div style="color:#556677;text-align:center;padding:20px">ğŸ“‹ Activity Log â€” ç­‰å¾…äº‹ä»¶ä¸­...</div></div>

<!-- Mobile: Toolbar toggle -->
<div class="mobile-toolbar-toggle" id="mobileToolbarToggle" onclick="document.querySelector('.toolbar').classList.toggle('mobile-show'); this.querySelector('.arrow').textContent = document.querySelector('.toolbar').classList.contains('mobile-show') ? 'â–¼' : 'â–²'">
  ğŸ›  å·¥å…·åˆ— <span class="arrow">â–²</span>
</div>

<div class="toolbar">
  <button id="btnAddSloth">åŠ æ¨¹æ‡¶</button>
  <button id="btnGenSloth" style="background:#4a148c;border-color:#6a1b9a">âœ¨ æ–°å¢æ¨¹æ‡¶</button>
  <button id="btnSave" style="background:#1b5e20;border-color:#2e7d32">ğŸ’¾ ä¿å­˜</button>
  <button class="btn-reset" id="btnReset">é‡ç½®ä½ˆå±€</button>
  <button id="btnDemo" style="background:#4a148c;border-color:#6a1b9a">ğŸ¬ Demo</button>
</div>

<!-- Activity Log Panel -->
<div class="log-panel collapsed" id="logPanel">
  <div class="log-panel-header" onclick="toggleLogPanel()">
    <h3>ğŸ“‹ Activity Log</h3>
    <span class="toggle-icon">â–¼</span>
  </div>
  <div class="log-entries" id="logEntries"></div>
</div>

<!-- Character Picker Modal -->
<div class="modal-overlay" id="pickerModal">
  <div class="modal">
    <button class="close-btn" onclick="closeModal('pickerModal')">&times;</button>
    <h3>é¸æ“‡æ¨¹æ‡¶è§’è‰²</h3>
    <div class="picker-grid" id="pickerGrid"></div>
  </div>
</div>

<!-- New Office Modal -->
<div class="modal-overlay" id="newOfficeModal">
  <div class="modal new-office-modal" style="min-width:420px">
    <button class="close-btn" onclick="closeModal('newOfficeModal')">&times;</button>
    <h3>æ–°å¢è¾¦å…¬å®¤</h3>
    <div id="newOfficeForm">
      <label>è¾¦å…¬å®¤åç¨±</label>
      <input type="text" id="newOfficeName" placeholder="ä¾‹ï¼šç ”ç™¼å®¤" maxlength="20">

      <label>èƒŒæ™¯è¨­å®š</label>
      <div class="option-group">
        <button class="option-btn selected" id="optUpload" onclick="selectBgOption('upload')">ä¸Šå‚³èƒŒæ™¯åœ–</button>
        <button class="option-btn" id="optAI" onclick="selectBgOption('ai')">AI ç”ŸæˆèƒŒæ™¯</button>
      </div>

      <div id="uploadSection">
        <input type="file" id="bgFileInput" accept="image/*" style="display:none">
        <button class="option-btn" style="width:100%;margin-bottom:12px" onclick="document.getElementById('bgFileInput').click()">
          é¸æ“‡åœ–ç‰‡æª”æ¡ˆ...
        </button>
        <div id="uploadPreview" style="display:none;margin-bottom:12px;text-align:center">
          <img id="uploadImg" style="max-width:100%;max-height:150px;border-radius:6px">
        </div>
      </div>

      <div id="aiSection" style="display:none">
        <label>æè¿°ä½ æƒ³è¦çš„è¾¦å…¬å®¤é¢¨æ ¼</label>
        <textarea id="aiDesc" rows="3" placeholder="ä¾‹ï¼šä¸€é–“å……æ»¿ç¶ è‰²æ¤ç‰©çš„é–‹æ”¾å¼è¾¦å…¬å®¤ï¼Œæœ‰å¤§ç‰‡è½åœ°çª—"></textarea>
        <div class="hint">æç¤ºï¼šæè¿°ç©ºé–“é¢¨æ ¼ã€è‰²èª¿ã€å®¶å…·æ“ºè¨­ç­‰</div>
      </div>

      <button class="submit-btn" onclick="createNewOffice()">å»ºç«‹è¾¦å…¬å®¤</button>
    </div>
    <div class="ai-loading" id="aiLoading">
      <div class="spinner"></div>
      <div>AI æ­£åœ¨ç”Ÿæˆè¾¦å…¬å®¤èƒŒæ™¯...</div>
      <div style="font-size:11px;margin-top:6px;color:#556677">é€™å¯èƒ½éœ€è¦ä¸€äº›æ™‚é–“</div>
    </div>
  </div>
</div>

<!-- Delete Confirm Modal -->
<!-- Generate Sloth Modal -->
<div class="modal-overlay" id="genSlothModal">
  <div class="modal" style="min-width:380px">
    <button class="close-btn" onclick="closeModal('genSlothModal')">&times;</button>
    <h3 style="margin-bottom:12px">âœ¨ AI ç”Ÿæˆæ–°æ¨¹æ‡¶</h3>
    <div id="genSlothForm">
      <label style="display:block;margin-bottom:4px;color:#a0b0c0;font-size:12px">æ¨¹æ‡¶åç¨±</label>
      <input type="text" id="genSlothName" placeholder="ä¾‹ï¼šå’–å•¡æ‡¶" style="width:100%;padding:8px;margin-bottom:12px;background:#0d1525;color:#e8d5b7;border:1px solid #1a3a5c;border-radius:6px;font-size:14px">
      <label style="display:block;margin-bottom:4px;color:#a0b0c0;font-size:12px">æè¿°å¤–è§€å’Œå·¥ä½œ</label>
      <textarea id="genSlothDesc" rows="3" placeholder="ä¾‹ï¼šæˆ´è‘—æ£•è‰²ç‰›ä»”å¸½çš„æ¨¹æ‡¶ï¼Œè² è²¬ç¤¾ç¾¤ç¶“ç‡Ÿï¼Œæ‰‹ä¸Šæ‹¿è‘—æ‰‹æ©Ÿ" style="width:100%;padding:8px;background:#0d1525;color:#e8d5b7;border:1px solid #1a3a5c;border-radius:6px;font-size:14px;resize:vertical"></textarea>
      <p style="font-size:11px;color:#556677;margin:6px 0 12px">æœƒç”Ÿæˆ 4 å€‹è§’åº¦çš„ä¸€è‡´è§’è‰²ï¼ˆå«æ¡Œæ¤…ï¼‰ï¼Œç´„éœ€ 1-2 åˆ†é˜</p>
      <button id="genSlothSubmit" style="width:100%;padding:10px;background:#4a148c;color:#fff;border:1px solid #6a1b9a;border-radius:8px;cursor:pointer;font-size:14px;font-weight:600">ğŸ¦¥ é–‹å§‹ç”Ÿæˆ</button>
    </div>
    <div id="genSlothLoading" style="display:none;text-align:center;padding:30px 0">
      <div style="font-size:24px;margin-bottom:12px">ğŸ”„</div>
      <p style="color:#a0b0c0">AI æ­£åœ¨ç”Ÿæˆæ¨¹æ‡¶è§’è‰²...</p>
      <p style="color:#556677;font-size:12px;margin-top:8px" id="genSlothStatus">æäº¤ä¸­...</p>
    </div>
  </div>
</div>

<div class="modal-overlay" id="deleteModal">
  <div class="modal" style="min-width:300px;text-align:center">
    <h3 style="margin-bottom:12px">ç¢ºèªåˆªé™¤</h3>
    <p style="color:#a0b0c0;margin-bottom:20px;font-size:14px" id="deleteMsg">ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ</p>
    <div style="display:flex;gap:10px;justify-content:center">
      <button id="deleteConfirm" style="padding:8px 24px;background:#5a1515;color:#ff8888;border:1px solid #6b2020;border-radius:8px;cursor:pointer;font-size:13px">åˆªé™¤</button>
      <button id="deleteCancel" style="padding:8px 24px;background:#0d1525;color:#a0b0c0;border:1px solid #1a3a5c;border-radius:8px;cursor:pointer;font-size:13px">å–æ¶ˆ</button>
    </div>
  </div>
</div>

<script>
/* ===== Character Data ===== */
const SLOTHS = {
  'kevin': { name: 'Kevinå°å¹«æ‰‹', role: 'ç§˜æ›¸/ç¸½æŒ‡æ® ğŸ¯' },
  'alex': { name: 'Alex', role: 'AIå·¥ç¨‹å¸« ğŸ’»' },
  'lena': { name: 'Lena', role: 'ç ”ç©¶å“¡ ğŸ”' },
  'writer': { name: 'Writer', role: 'æ–‡æ¡ˆå°ˆå®¶ âœï¸' },
  'n8n_bot': { name: 'N8Nå°å¹«æ‰‹', role: 'è‡ªå‹•åŒ–å°ˆå®¶ âš™ï¸' },
  'secguard': { name: 'SecGuard', role: 'è³‡å®‰å®ˆè¡› ğŸ›¡ï¸' },
  // Legacy aliases
  '01': { name: 'Kevinå°å¹«æ‰‹', role: 'ç§˜æ›¸/ç¸½æŒ‡æ® ğŸ¯' },
  '02': { name: 'Alex', role: 'AIå·¥ç¨‹å¸« ğŸ’»' },
  '03': { name: 'Lena', role: 'ç ”ç©¶å“¡ ğŸ”' },
  '04': { name: 'Writer', role: 'æ–‡æ¡ˆå°ˆå®¶ âœï¸' },
};

const DIRECTIONS = ['sw', 'se', 'nw', 'ne'];

/* Default desk positions (isometric perspective) */
const DESK_POSITIONS = [
  { left: 24, top: 74, scale: 100 },
  { left: 29, top: 52, scale: 100 },
  { left: 44, top: 68, scale: 100 },
  { left: 59, top: 48, scale: 100 },
  { left: 62, top: 55, scale: 100 },
];
const DEFAULT_SLOTHS = ['kevin', 'alex', 'lena', 'writer', 'n8n_bot'];

/* ===== State ===== */
const STORAGE_KEY = 'sloth-office-v4';
let offices = [];
let currentOfficeId = null;
let selectedId = null;
let nextSlothId = 1;
let nextZ = 10;
let dragState = null;
let deleteTarget = null; // 'sloth' or 'office'
let deleteOfficeId = null;
let currentView = 'office'; // 'office' or 'security'

const canvas = document.getElementById('canvas');
const tabBar = document.getElementById('tabBar');

/* ===== Activity tracking removed - agents stay at their desks ===== */

/* ===== Helpers ===== */
// Agents that use pixel-art sprites from assets/agents/
const PIXEL_AGENTS = new Set(['alex', 'n8n_bot']);

function slothSrc(charId, dir) {
  // charId: 'kevin', 'alex', etc. (named agents) or '01'-'04' (legacy) or 'sloth_xxx' (AI generated)
  const v = '20260203';
  if (charId.startsWith('sloth_')) return `assets/sloths/${charId}_${dir}.png?v=${v}`;
  if (/^\d{2}$/.test(charId)) return `assets/sloths/sloth_${charId}_${dir}.png?v=${v}`;
  if (PIXEL_AGENTS.has(charId)) return `assets/agents/${charId}_${dir}.png?v=${v}`;
  return `assets/sloths/${charId}_${dir}.png?v=${v}`;
}
function getEl(id) { return canvas.querySelector(`.sloth[data-id="${id}"]`); }
function currentOffice() { return offices.find(o => o.id === currentOfficeId); }
function findSloth(id) {
  const office = currentOffice();
  return office ? office.sloths.find(s => s.id === id) : null;
}

/* ===== Persistence (Feature 9) - Server-side ===== */
function saveAll() {
  const data = offices.map(o => ({
    id: o.id, name: o.name, bgType: o.bgType,
    bgData: o.bgData, aiPrompt: o.aiPrompt,
    bgUrl: o.bgUrl,
    sloths: o.sloths.map(s => ({
      id: s.id, charId: s.charId, name: s.name, role: s.role,
      leftPct: Math.round(s.leftPct * 10) / 10,
      topPct: Math.round(s.topPct * 10) / 10,
      direction: s.direction, scale: s.scale, zIndex: s.zIndex,
    })),
  }));
  const payload = { offices: data, currentId: currentOfficeId, customSloths: {} };
  // Save custom sloth definitions (AI generated)
  Object.entries(SLOTHS).forEach(([k, v]) => {
    if (k.startsWith('sloth_')) payload.customSloths[k] = v;
  });
  // Save to server (fire and forget)
  fetch('/api/save', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload),
  }).catch(() => {});
}

async function loadAll() {
  try {
    const res = await fetch('/api/load');
    const json = await res.json();
    return json.ok ? json.data : null;
  } catch { return null; }
}

/* ===== Office Management (Feature 10) ===== */
function genOfficeId() { return 'office_' + Date.now() + '_' + Math.random().toString(36).slice(2, 6); }

function createDefaultOffice() {
  const id = genOfficeId();
  const sloths = [];
  for (let i = 0; i < DEFAULT_SLOTHS.length; i++) {
    const charId = DEFAULT_SLOTHS[i];
    const pos = DESK_POSITIONS[i];
    const info = SLOTHS[charId];
    sloths.push({
      id: nextSlothId++, charId,
      leftPct: pos.left, topPct: pos.top,
      direction: 'sw', scale: pos.scale, zIndex: 10 + i,
      name: info.name, role: info.role,
    });
  }
  return { id, name: 'ä¸»è¾¦å…¬å®¤', bgType: 'default', bgData: null, aiPrompt: null, sloths };
}

function renderTabs() {
  tabBar.innerHTML = '';
  offices.forEach(o => {
    const tab = document.createElement('button');
    tab.className = 'tab' + (o.id === currentOfficeId ? ' active' : '');
    tab.dataset.officeId = o.id;
    tab.innerHTML = `<span class="tab-label">${escHtml(o.name)}</span>`;

    // Close button only if more than 1 office
    if (offices.length > 1) {
      const close = document.createElement('button');
      close.className = 'tab-close';
      close.textContent = 'Ã—';
      close.addEventListener('click', (e) => {
        e.stopPropagation();
        confirmDeleteOffice(o.id);
      });
      tab.appendChild(close);
    }

    tab.addEventListener('click', () => switchOffice(o.id));
    tab.addEventListener('dblclick', (e) => {
      e.stopPropagation();
      startRenameTab(o.id, tab);
    });
    tab.addEventListener('contextmenu', (e) => {
      e.preventDefault();
      showTabContextMenu(e, o.id);
    });
    tabBar.appendChild(tab);
  });

  const addBtn = document.createElement('button');
  addBtn.className = 'tab-add';
  addBtn.textContent = '+ æ–°å¢';
  addBtn.addEventListener('click', openNewOfficeModal);
  tabBar.appendChild(addBtn);

  // Security tab
  const secTab = document.createElement('button');
  secTab.className = 'tab' + (currentView === 'security' ? ' active' : '');
  secTab.innerHTML = '<span class="tab-label">ğŸ›¡ å®‰å…¨</span>';
  secTab.addEventListener('click', () => switchToSecurity());
  tabBar.appendChild(secTab);
}

function escHtml(s) {
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

function switchToSecurity() {
  currentView = 'security';
  document.querySelector('.main').style.display = 'none';
  document.getElementById('securityDashboard').style.display = '';
  document.querySelector('.toolbar').style.display = 'none';
  renderTabs();
  loadSecurityDashboard();
}

function switchToOffice() {
  currentView = 'office';
  document.querySelector('.main').style.display = '';
  document.getElementById('securityDashboard').style.display = 'none';
  document.querySelector('.toolbar').style.display = '';
  renderTabs();
}

function switchOffice(id) {
  if (currentView === 'security') switchToOffice();
  if (currentOfficeId === id && currentView === 'office') return;
  selectedId = null;
  currentOfficeId = id;
  renderCanvas();
  renderTabs();
  updatePanel();
  saveAll();
}

function renderCanvas() {
  canvas.innerHTML = '';
  const office = currentOffice();
  if (!office) return;

  // Background
  if (office.bgType === 'default') {
    const img = document.createElement('img');
    img.className = 'bg';
    img.src = 'assets/offices/default_v2.jpg';
    img.draggable = false;
    canvas.appendChild(img);
  } else if (office.bgType === 'upload' && (office.bgData || office.bgUrl)) {
    const img = document.createElement('img');
    img.className = 'bg';
    img.src = office.bgData || office.bgUrl;
    img.draggable = false;
    canvas.appendChild(img);
  } else if (office.bgType === 'ai') {
    const div = document.createElement('div');
    div.className = 'bg-placeholder';
    div.innerHTML = `AI èƒŒæ™¯ç”Ÿæˆä¸­...<br><br><span style="font-size:11px;color:#445566">${escHtml(office.aiPrompt || '')}</span>`;
    canvas.appendChild(div);
  } else {
    // Fallback: use default background
    const img = document.createElement('img');
    img.className = 'bg';
    img.src = 'assets/offices/default_v2.jpg';
    img.draggable = false;
    canvas.appendChild(img);
  }

  // Sloths
  nextZ = 10;
  office.sloths.forEach(s => {
    renderSlothEl(s);
    if (s.zIndex >= nextZ) nextZ = s.zIndex + 1;
  });
}

function renderSlothEl(sloth) {
  const el = document.createElement('div');
  el.className = 'sloth' + (sloth.id === selectedId ? ' selected' : '');
  el.dataset.id = sloth.id;

  const img = document.createElement('img');
  img.src = slothSrc(sloth.charId, sloth.direction);
  img.draggable = false;
  if (PIXEL_AGENTS.has(sloth.charId)) img.style.imageRendering = 'pixelated';
  el.appendChild(img);

  const tag = document.createElement('div');
  tag.className = 'name-tag';
  tag.innerHTML = `<div class="nt-name">${escHtml(sloth.name)}</div><div class="nt-role">${escHtml(sloth.role || '')}</div>`;
  el.appendChild(tag);

  // Status dot
  const dot = document.createElement('div');
  dot.className = 'status-dot';
  el.appendChild(dot);

  // Task queue badge
  const badge = document.createElement('div');
  badge.className = 'queue-badge';
  badge.textContent = '0';
  el.appendChild(badge);

  applyStyle(el, sloth);
  canvas.appendChild(el);
  el.addEventListener('pointerdown', (e) => onPointerDown(e, sloth.id));
  // Fallback: also select on click (some browsers/tunnel proxies may not fire pointerdown)
  el.addEventListener('click', (e) => {
    if (!dragState || !dragState.moved) selectSloth(sloth.id);
  });
}

function applyStyle(el, sloth) {
  const widthPct = sloth.scale / 14;
  el.style.left = sloth.leftPct + '%';
  el.style.top = sloth.topPct + '%';
  el.style.width = widthPct + '%';
  el.style.zIndex = sloth.zIndex;
  el.style.transform = 'translate(-50%, -50%)';
  el.querySelector('img').src = slothSrc(sloth.charId, sloth.direction);
  const tag = el.querySelector('.name-tag');
  if (tag) tag.innerHTML = `<div class="nt-name">${escHtml(sloth.name)}</div><div class="nt-role">${escHtml(sloth.role || '')}</div>`;
}

/* ===== Tab Context Menu ===== */
let ctxMenu = null;

function showTabContextMenu(e, officeId) {
  removeCtxMenu();
  const menu = document.createElement('div');
  menu.className = 'ctx-menu';
  menu.style.left = e.clientX + 'px';
  menu.style.top = e.clientY + 'px';

  const renameBtn = document.createElement('button');
  renameBtn.textContent = 'é‡æ–°å‘½å';
  renameBtn.addEventListener('click', () => {
    removeCtxMenu();
    const tab = tabBar.querySelector(`[data-office-id="${officeId}"]`);
    if (tab) startRenameTab(officeId, tab);
  });
  menu.appendChild(renameBtn);

  if (offices.length > 1) {
    const delBtn = document.createElement('button');
    delBtn.className = 'ctx-danger';
    delBtn.textContent = 'åˆªé™¤è¾¦å…¬å®¤';
    delBtn.addEventListener('click', () => {
      removeCtxMenu();
      confirmDeleteOffice(officeId);
    });
    menu.appendChild(delBtn);
  }

  document.body.appendChild(menu);
  ctxMenu = menu;

  // Adjust if overflows
  const rect = menu.getBoundingClientRect();
  if (rect.right > window.innerWidth) menu.style.left = (window.innerWidth - rect.width - 4) + 'px';
  if (rect.bottom > window.innerHeight) menu.style.top = (window.innerHeight - rect.height - 4) + 'px';
}

function removeCtxMenu() {
  if (ctxMenu) { ctxMenu.remove(); ctxMenu = null; }
}
document.addEventListener('click', removeCtxMenu);

function startRenameTab(officeId, tabEl) {
  const office = offices.find(o => o.id === officeId);
  if (!office) return;
  const label = tabEl.querySelector('.tab-label');
  const input = document.createElement('input');
  input.className = 'tab-rename';
  input.value = office.name;
  input.maxLength = 20;
  label.replaceWith(input);
  input.focus();
  input.select();

  const finish = () => {
    const val = input.value.trim() || office.name;
    office.name = val;
    saveAll();
    renderTabs();
  };
  input.addEventListener('blur', finish);
  input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') { e.preventDefault(); input.blur(); }
    if (e.key === 'Escape') { input.value = office.name; input.blur(); }
  });
}

function confirmDeleteOffice(officeId) {
  const office = offices.find(o => o.id === officeId);
  if (!office || offices.length <= 1) return;
  deleteTarget = 'office';
  deleteOfficeId = officeId;
  document.getElementById('deleteMsg').textContent = `ç¢ºå®šè¦åˆªé™¤ã€Œ${office.name}ã€è¾¦å…¬å®¤å—ï¼Ÿ`;
  document.getElementById('deleteModal').classList.add('active');
}

/* ===== New Office Modal (Feature 11) ===== */
let bgOption = 'upload';
let uploadedBgData = null;

function openNewOfficeModal() {
  bgOption = 'upload';
  uploadedBgData = null;
  document.getElementById('newOfficeName').value = '';
  document.getElementById('aiDesc').value = '';
  document.getElementById('uploadPreview').style.display = 'none';
  document.getElementById('bgFileInput').value = '';
  document.getElementById('newOfficeForm').style.display = '';
  document.getElementById('aiLoading').classList.remove('active');
  selectBgOption('upload');
  document.getElementById('newOfficeModal').classList.add('active');
}

function selectBgOption(opt) {
  bgOption = opt;
  document.getElementById('optUpload').classList.toggle('selected', opt === 'upload');
  document.getElementById('optAI').classList.toggle('selected', opt === 'ai');
  document.getElementById('uploadSection').style.display = opt === 'upload' ? '' : 'none';
  document.getElementById('aiSection').style.display = opt === 'ai' ? '' : 'none';
}
window.selectBgOption = selectBgOption;

document.getElementById('bgFileInput').addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    uploadedBgData = reader.result;
    document.getElementById('uploadImg').src = uploadedBgData;
    document.getElementById('uploadPreview').style.display = '';
  };
  reader.readAsDataURL(file);
});

function createNewOffice() {
  const name = document.getElementById('newOfficeName').value.trim() || 'æ–°è¾¦å…¬å®¤';

  if (bgOption === 'ai') {
    const desc = document.getElementById('aiDesc').value.trim();
    if (!desc) { document.getElementById('aiDesc').focus(); return; }

    document.getElementById('newOfficeForm').style.display = 'none';
    document.getElementById('aiLoading').classList.add('active');

    // Close modal, generate in background with notification
    closeModal('newOfficeModal');
    addNotif('pending', `ğŸ¢ ç”Ÿæˆä¸­ï¼š${name}`, 'AI è¾¦å…¬å®¤èƒŒæ™¯ç”Ÿæˆä¸­ï¼Œç´„ 1-2 åˆ†é˜...', null);

    fetch(API_BASE + '/api/generate-office', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ description: desc }),
    })
    .then(r => r.json())
    .then(data => {
      if (!data.ok) throw new Error(data.error);
      const officeId = genOfficeId();
      const office = { id: officeId, name, bgType: 'upload', bgData: null, bgUrl: data.bgUrl, aiPrompt: desc, sloths: [] };
      offices.push(office);
      renderTabs();
      saveAll();

      notifications = notifications.filter(n => n.title !== `ğŸ¢ ç”Ÿæˆä¸­ï¼š${name}`);
      addNotif('success', `âœ… ${name} å»ºç«‹å®Œæˆï¼`, 'AI è¾¦å…¬å®¤èƒŒæ™¯å·²ç”Ÿæˆ',
        () => switchOffice(officeId));
    })
    .catch(e => {
      notifications = notifications.filter(n => n.title !== `ğŸ¢ ç”Ÿæˆä¸­ï¼š${name}`);
      addNotif('error', `âŒ ${name} ç”Ÿæˆå¤±æ•—`, e.message, null);
    });
  } else {
    const office = {
      id: genOfficeId(), name,
      bgType: uploadedBgData ? 'upload' : 'default',
      bgData: uploadedBgData, aiPrompt: null, sloths: [],
    };
    offices.push(office);
    closeModal('newOfficeModal');
    switchOffice(office.id);
  }
}
window.createNewOffice = createNewOffice;

/* ===== Drag (Feature 2) ===== */
function onPointerDown(e, id) {
  e.preventDefault();
  e.stopPropagation();
  selectSloth(id);

  const sloth = findSloth(id);
  const el = getEl(id);
  const rect = canvas.getBoundingClientRect();

  dragState = {
    id,
    startX: e.clientX, startY: e.clientY,
    origLeft: sloth.leftPct, origTop: sloth.topPct,
    cw: rect.width, ch: rect.height,
    moved: false,
  };

  el.setPointerCapture(e.pointerId);
  el.addEventListener('pointermove', onPointerMove);
  el.addEventListener('pointerup', onPointerUp);
}

function onPointerMove(e) {
  if (!dragState) return;
  const dx = e.clientX - dragState.startX;
  const dy = e.clientY - dragState.startY;
  if (Math.abs(dx) > 2 || Math.abs(dy) > 2) dragState.moved = true;
  const sloth = findSloth(dragState.id);
  if (!sloth) return;
  sloth.leftPct = dragState.origLeft + (dx / dragState.cw) * 100;
  sloth.topPct = dragState.origTop + (dy / dragState.ch) * 100;
  applyStyle(getEl(dragState.id), sloth);
  updatePanel();
}

function onPointerUp(e) {
  if (!dragState) return;
  const el = getEl(dragState.id);
  if (el) {
    el.releasePointerCapture(e.pointerId);
    el.removeEventListener('pointermove', onPointerMove);
    el.removeEventListener('pointerup', onPointerUp);
  }
  if (dragState.moved) saveAll();
  dragState = null;
}

canvas.addEventListener('pointerdown', (e) => {
  if (e.target === canvas || e.target.classList.contains('bg') || e.target.classList.contains('bg-placeholder')) {
    selectSloth(null);
  }
});

/* ===== Selection (Feature 3) ===== */
function selectSloth(id) {
  const prev = canvas.querySelector('.sloth.selected');
  if (prev) prev.classList.remove('selected');
  selectedId = id;
  if (id !== null) {
    const el = getEl(id);
    if (el) el.classList.add('selected');
  }
  updatePanel();
}

/* ===== Panel (Feature 3) ===== */
function updatePanel() {
  const empty = document.getElementById('panelEmpty');
  const content = document.getElementById('panelContent');
  const tabs = document.getElementById('panelTabs');
  const detail = document.getElementById('panelDetail');
  if (selectedId === null) {
    empty.style.display = '';
    content.style.display = 'none';
    tabs.style.display = 'none';
    detail.style.display = 'none';
    return;
  }
  empty.style.display = 'none';
  tabs.style.display = '';
  switchPanelTab(currentPanelTab);

  const sloth = findSloth(selectedId);
  if (!sloth) { selectSloth(null); return; }

  // Load agent detail from API
  if (sloth.charId) loadAgentDetail(sloth.charId);

  document.getElementById('propName').textContent = sloth.name;
  document.getElementById('propRole').textContent = sloth.role;
  document.getElementById('propPos').textContent = `${sloth.leftPct.toFixed(1)}%, ${sloth.topPct.toFixed(1)}%`;

  document.querySelectorAll('#dirGroup button').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.dir === sloth.direction);
  });

  document.getElementById('scaleSlider').value = sloth.scale;
  document.getElementById('scaleVal').textContent = sloth.scale + '%';
}

/* ===== Direction (Feature 4) ===== */
document.querySelectorAll('#dirGroup button').forEach(btn => {
  btn.addEventListener('click', () => {
    if (selectedId === null) return;
    const sloth = findSloth(selectedId);
    sloth.direction = btn.dataset.dir;
    applyStyle(getEl(selectedId), sloth);
    updatePanel();
    saveAll();
  });
});

/* ===== Scale (Feature 5) ===== */
document.getElementById('scaleSlider').addEventListener('input', (e) => {
  if (selectedId === null) return;
  const sloth = findSloth(selectedId);
  sloth.scale = parseInt(e.target.value);
  applyStyle(getEl(selectedId), sloth);
  document.getElementById('scaleVal').textContent = sloth.scale + '%';
});
document.getElementById('scaleSlider').addEventListener('change', saveAll);

/* ===== Layer Ordering (Feature 6) ===== */
document.getElementById('btnZUp').addEventListener('click', () => {
  if (selectedId === null) return;
  const sloth = findSloth(selectedId);
  sloth.zIndex += 1;
  getEl(selectedId).style.zIndex = sloth.zIndex;
  saveAll();
});
document.getElementById('btnZDown').addEventListener('click', () => {
  if (selectedId === null) return;
  const sloth = findSloth(selectedId);
  sloth.zIndex = Math.max(1, sloth.zIndex - 1);
  getEl(selectedId).style.zIndex = sloth.zIndex;
  saveAll();
});

/* ===== Character Picker (Feature 7) ===== */
document.getElementById('btnAddSloth').addEventListener('click', () => {
  const grid = document.getElementById('pickerGrid');
  grid.innerHTML = '';
  Object.entries(SLOTHS).forEach(([id, info]) => {
    const item = document.createElement('div');
    item.className = 'picker-item';
    item.innerHTML = `
      <img src="${slothSrc(id, 'sw')}" draggable="false">
      <div class="p-name">${info.name}</div>
      <div class="p-role">${info.role}</div>
    `;
    item.addEventListener('click', () => {
      addSlothToScene(id);
      closeModal('pickerModal');
    });
    grid.appendChild(item);
  });
  document.getElementById('pickerModal').classList.add('active');
});

function addSlothToScene(charId) {
  const office = currentOffice();
  if (!office) return;
  const info = SLOTHS[charId] || {};
  const sloth = {
    id: nextSlothId++, charId,
    leftPct: 50, topPct: 50,
    direction: 'sw', scale: 100, zIndex: nextZ++,
    name: info.name || 'æ¨¹æ‡¶', role: info.role || '',
  };
  office.sloths.push(sloth);
  renderSlothEl(sloth);
  selectSloth(sloth.id);
  saveAll();
}

/* ===== Delete (Feature 8) ===== */
document.getElementById('btnDelete').addEventListener('click', () => {
  if (selectedId === null) return;
  const sloth = findSloth(selectedId);
  deleteTarget = 'sloth';
  document.getElementById('deleteMsg').textContent = `ç¢ºå®šè¦åˆªé™¤ã€Œ${sloth.name}ã€å—ï¼Ÿ`;
  document.getElementById('deleteModal').classList.add('active');
});

document.getElementById('deleteConfirm').addEventListener('click', () => {
  document.getElementById('deleteModal').classList.remove('active');

  if (deleteTarget === 'sloth' && selectedId !== null) {
    const office = currentOffice();
    const el = getEl(selectedId);
    if (el) el.remove();
    office.sloths = office.sloths.filter(s => s.id !== selectedId);
    selectSloth(null);
    saveAll();
  } else if (deleteTarget === 'office' && deleteOfficeId) {
    offices = offices.filter(o => o.id !== deleteOfficeId);
    if (currentOfficeId === deleteOfficeId) {
      currentOfficeId = offices[0].id;
      renderCanvas();
    }
    renderTabs();
    updatePanel();
    saveAll();
    deleteOfficeId = null;
  }
  deleteTarget = null;
});

document.getElementById('deleteCancel').addEventListener('click', () => {
  document.getElementById('deleteModal').classList.remove('active');
  deleteTarget = null;
  deleteOfficeId = null;
});

/* ===== Reset Layout ===== */
document.getElementById('btnReset').addEventListener('click', () => {
  if (!confirm('ç¢ºå®šè¦é‡ç½®æ­¤è¾¦å…¬å®¤çš„ä½ˆå±€å—ï¼Ÿ')) return;
  const office = currentOffice();
  if (!office) return;

  office.sloths = [];
  nextSlothId = Math.max(nextSlothId, 100);

  // Restore defaults only for the main default office
  if (office.bgType === 'default') {
    for (let i = 0; i < DEFAULT_SLOTHS.length; i++) {
      const charId = DEFAULT_SLOTHS[i];
      const pos = DESK_POSITIONS[i];
      const info = SLOTHS[charId];
      office.sloths.push({
        id: nextSlothId++, charId,
        leftPct: pos.left, topPct: pos.top,
        direction: 'sw', scale: pos.scale, zIndex: 10 + i,
        name: info.name, role: info.role,
      });
    }
  }

  selectedId = null;
  renderCanvas();
  updatePanel();
  saveAll();
});

/* ===== Modal Helpers ===== */
function closeModal(id) {
  document.getElementById(id).classList.remove('active');
}
window.closeModal = closeModal;

// Close modals on overlay click
document.querySelectorAll('.modal-overlay').forEach(overlay => {
  overlay.addEventListener('click', (e) => {
    if (e.target === overlay) overlay.classList.remove('active');
  });
});

/* ===== Notification System ===== */
const API_BASE = '';
let notifications = [];

function addNotif(type, title, message, actionFn) {
  notifications.unshift({ type, title, message, actionFn, time: new Date() });
  renderNotifs();
}

function renderNotifs() {
  const bell = document.getElementById('notifBell');
  const badge = document.getElementById('notifBadge');
  const list = document.getElementById('notifList');
  
  bell.style.display = notifications.length > 0 ? '' : 'none';
  badge.style.display = notifications.length > 0 ? '' : 'none';
  badge.textContent = notifications.length;
  
  list.innerHTML = '';
  notifications.forEach((n, i) => {
    const div = document.createElement('div');
    div.style.cssText = 'padding:10px;margin-bottom:6px;background:#0d1525;border-radius:8px;border-left:3px solid ' + 
      (n.type === 'success' ? '#00e676' : n.type === 'error' ? '#e53935' : '#f0a500');
    
    let html = `<div style="font-weight:600;margin-bottom:4px;color:#e8d5b7">${n.title}</div>`;
    html += `<div style="color:#8899aa;font-size:12px;margin-bottom:6px">${n.message}</div>`;
    div.innerHTML = html;
    
    if (n.actionFn) {
      const btn = document.createElement('button');
      btn.textContent = 'æŸ¥çœ‹æ•ˆæœ';
      btn.style.cssText = 'padding:4px 12px;background:#1a3a5c;color:#e8d5b7;border:1px solid #2a4a6c;border-radius:6px;cursor:pointer;font-size:12px';
      btn.addEventListener('click', () => {
        n.actionFn();
        notifications.splice(i, 1);
        renderNotifs();
        document.getElementById('notifPanel').style.display = 'none';
      });
      div.appendChild(btn);
    }
    list.appendChild(div);
  });
}

function toggleNotifPanel() {
  const panel = document.getElementById('notifPanel');
  panel.style.display = panel.style.display === 'none' ? '' : 'none';
}

function clearNotifs() {
  notifications = [];
  renderNotifs();
  document.getElementById('notifPanel').style.display = 'none';
}

// Close panel on click outside
document.addEventListener('click', (e) => {
  const panel = document.getElementById('notifPanel');
  const bell = document.getElementById('notifBell');
  if (!panel.contains(e.target) && !bell.contains(e.target)) {
    panel.style.display = 'none';
  }
});

/* ===== Generate Sloth (Feature: AI) ===== */
document.getElementById('btnGenSloth').addEventListener('click', () => {
  document.getElementById('genSlothName').value = '';
  document.getElementById('genSlothDesc').value = '';
  document.getElementById('genSlothForm').style.display = '';
  document.getElementById('genSlothLoading').style.display = 'none';
  document.getElementById('genSlothModal').classList.add('active');
});

document.getElementById('genSlothSubmit').addEventListener('click', () => {
  const name = document.getElementById('genSlothName').value.trim() || 'æ–°æ¨¹æ‡¶';
  const desc = document.getElementById('genSlothDesc').value.trim();
  if (!desc) { document.getElementById('genSlothDesc').focus(); return; }

  // Show brief loading then close modal
  document.getElementById('genSlothForm').style.display = 'none';
  document.getElementById('genSlothLoading').style.display = '';
  document.getElementById('genSlothStatus').textContent = 'å·²æäº¤ï¼å¯ä»¥é—œé–‰æ­¤è¦–çª—ï¼Œå®Œæˆå¾Œæœƒé€šçŸ¥ä½  ğŸ””';
  
  setTimeout(() => closeModal('genSlothModal'), 1500);

  // Background generation
  addNotif('pending', `ğŸ¦¥ ç”Ÿæˆä¸­ï¼š${name}`, '4 è§’åº¦è§’è‰²ç”Ÿæˆä¸­ï¼Œç´„ 1-2 åˆ†é˜...', null);

  fetch(API_BASE + '/api/generate-sloth', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ name, description: desc }),
  })
  .then(r => r.json())
  .then(data => {
    if (!data.ok) throw new Error(data.error || 'failed');
    const sid = data.slothId;
    SLOTHS[sid] = { name, role: desc.substring(0, 30) };
    
    // Remove pending notif
    notifications = notifications.filter(n => n.title !== `ğŸ¦¥ ç”Ÿæˆä¸­ï¼š${name}`);
    
    // Add success notif with action to add to scene
    addNotif('success', `âœ… ${name} ç”Ÿæˆå®Œæˆï¼`, '4 è§’åº¦è§’è‰²å·²å°±ç·’',
      () => addSlothToScene(sid));
  })
  .catch(e => {
    notifications = notifications.filter(n => n.title !== `ğŸ¦¥ ç”Ÿæˆä¸­ï¼š${name}`);
    addNotif('error', `âŒ ${name} ç”Ÿæˆå¤±æ•—`, e.message, null);
  });
});

/* ===== Save Button ===== */
document.getElementById('btnSave').addEventListener('click', () => {
  saveAll();
  const btn = document.getElementById('btnSave');
  const orig = btn.textContent;
  btn.textContent = 'âœ… å·²ä¿å­˜ï¼';
  btn.style.background = '#2e7d32';
  setTimeout(() => { btn.textContent = orig; btn.style.background = '#1b5e20'; }, 1500);
});

/* ===== Keyboard ===== */
document.addEventListener('keydown', (e) => {
  if (e.key === 'Delete' || e.key === 'Backspace') {
    if (selectedId !== null && document.activeElement === document.body) {
      document.getElementById('btnDelete').click();
    }
  }
  if (e.key === 'Escape') {
    document.querySelectorAll('.modal-overlay.active').forEach(m => m.classList.remove('active'));
    removeCtxMenu();
    selectSloth(null);
  }
});

/* ===== Init ===== */
async function init() {
  const saved = await loadAll();
  if (saved && saved.offices && saved.offices.length > 0) {
    offices = saved.offices;
    // Restore custom sloth definitions
    if (saved.customSloths) {
      Object.entries(saved.customSloths).forEach(([k, v]) => { SLOTHS[k] = v; });
    }
    // Restore nextSlothId
    offices.forEach(o => {
      o.sloths.forEach(s => {
        if (s.id >= nextSlothId) nextSlothId = s.id + 1;
      });
    });
    currentOfficeId = saved.currentId || offices[0].id;
    if (!offices.find(o => o.id === currentOfficeId)) currentOfficeId = offices[0].id;
  } else {
    const def = createDefaultOffice();
    offices = [def];
    currentOfficeId = def.id;
  }

  renderTabs();
  renderCanvas();
  updatePanel();
}

init();

/* ===== LIVE Animation Engine ===== */

// Agent name mapping: Clawdbot agent IDs â†’ sloth names in the office
// Users can customize this. Falls back to searching by name/role.
const AGENT_MAP = {
  kevin: ['Kevin', 'å°ç¾', 'Kevin å°å¹«æ‰‹'],
  'kevinå°å¹«æ‰‹': ['Kevin', 'Kevin å°å¹«æ‰‹'],
  'Kevinå°å¹«æ‰‹': ['Kevin', 'Kevin å°å¹«æ‰‹'],
  alex: ['Alex', 'é˜¿æ‡¶', 'Engineer'],
  lena: ['Lena', 'æ‡¶æ‡¶', 'åŠ©ç†'],
  writer: ['Writer', 'å°èƒ–', 'å¯«æ–‡å°ˆå®¶'],
  n8n_bot: ['N8N Bot', 'N8N', 'è‡ªå‹•åŒ–'],
  'n8n-bot': ['N8N Bot', 'N8N', 'è‡ªå‹•åŒ–'],
  'n8nå°å¹«æ‰‹': ['N8N Bot', 'N8N', 'è‡ªå‹•åŒ–'],
  'N8Nå°å¹«æ‰‹': ['N8N Bot', 'N8N', 'è‡ªå‹•åŒ–'],
  'n8n': ['N8N Bot', 'N8N', 'è‡ªå‹•åŒ–'],
  'secguard': ['SecGuard', 'è³‡å®‰å®ˆè¡›'],
  'SecGuard': ['SecGuard', 'è³‡å®‰å®ˆè¡›'],
};

const AGENT_DISPLAY = {
  kevin: 'Kevin å°å¹«æ‰‹',
  'kevinå°å¹«æ‰‹': 'Kevin å°å¹«æ‰‹',
  'Kevinå°å¹«æ‰‹': 'Kevin å°å¹«æ‰‹',
  alex: 'Alex',
  lena: 'Lena',
  writer: 'Writer',
  n8n_bot: 'N8N Bot',
  'n8n-bot': 'N8N Bot',
  'n8nå°å¹«æ‰‹': 'N8N Bot',
  'N8Nå°å¹«æ‰‹': 'N8N Bot',
  'n8n': 'N8N Bot',
  'secguard': 'SecGuard',
  'SecGuard': 'SecGuard',
};

function findSlothElByAgentId(agentId) {
  const office = currentOffice();
  if (!office) return null;
  
  // Direct charId match (preferred)
  for (const sloth of office.sloths) {
    if (sloth.charId === agentId) return getEl(sloth.id);
  }
  
  const names = AGENT_MAP[agentId] || [agentId];
  
  // Try matching by sloth name or role
  for (const sloth of office.sloths) {
    for (const n of names) {
      if (sloth.name === n || sloth.name.includes(n) || sloth.role.includes(n)) {
        return getEl(sloth.id);
      }
    }
  }
  
  // Fallback: map by index (kevin=0, alex=1, lena=2, writer=3, n8n_bot=4)
  const order = ['kevin', 'alex', 'lena', 'writer', 'n8n_bot'];
  const idx = order.indexOf(agentId);
  if (idx >= 0 && idx < office.sloths.length) {
    return getEl(office.sloths[idx].id);
  }
  return null;
}

function getSlothCenter(agentId) {
  const el = findSlothElByAgentId(agentId);
  if (!el) return null;
  const canvasRect = canvas.getBoundingClientRect();
  const elRect = el.getBoundingClientRect();
  return {
    x: elRect.left + elRect.width / 2 - canvasRect.left,
    y: elRect.top - canvasRect.top - 10,
  };
}

function ensureStatusDot(el) {
  if (!el) return null;
  let dot = el.querySelector('.status-dot');
  if (!dot) {
    dot = document.createElement('div');
    dot.className = 'status-dot';
    el.appendChild(dot);
  }
  return dot;
}

function liveSetStatus(agentId, status) {
  const el = findSlothElByAgentId(agentId);
  const dot = ensureStatusDot(el);
  if (!dot) return;
  dot.className = 'status-dot';
  if (status === 'thinking') dot.classList.add('thinking');
  else if (status === 'busy') dot.classList.add('busy');
}

// Task queue tracking
const agentQueues = {};
function updateQueueBadge(agentId, delta) {
  if (!agentQueues[agentId]) agentQueues[agentId] = 0;
  agentQueues[agentId] = Math.max(0, agentQueues[agentId] + delta);
  const el = findSlothElByAgentId(agentId);
  if (!el) return;
  let badge = el.querySelector('.queue-badge');
  if (!badge) {
    badge = document.createElement('div');
    badge.className = 'queue-badge';
    el.appendChild(badge);
  }
  const count = agentQueues[agentId];
  badge.textContent = count;
  badge.classList.toggle('active', count > 0);
  if (count > 0) badge.style.animation = 'none'; badge.offsetHeight; badge.style.animation = '';
}

function liveShowBubble(agentId, text, cssClass, duration = 4000) {
  const el = findSlothElByAgentId(agentId);
  if (!el) return;
  const bubble = document.createElement('div');
  bubble.className = 'chat-bubble' + (cssClass ? ' ' + cssClass : '');
  bubble.innerHTML = text;
  bubble.style.animationDuration = (duration / 1000) + 's';
  el.appendChild(bubble);
  setTimeout(() => bubble.remove(), duration);
}

function liveFlyEnvelope(fromId, toId, label, duration = 1500) {
  return new Promise(resolve => {
    const from = getSlothCenter(fromId);
    const to = getSlothCenter(toId);
    if (!from || !to) { resolve(); return; }
    
    const env = document.createElement('div');
    env.className = 'envelope';
    env.innerHTML = `<span class="envelope-icon">âœ‰ï¸</span><span class="envelope-label">${label || ''}</span>`;
    env.style.left = from.x + 'px';
    env.style.top = from.y + 'px';
    canvas.appendChild(env);

    const midX = (from.x + to.x) / 2;
    const midY = Math.min(from.y, to.y) - 60;
    const startTime = performance.now();

    function animate(now) {
      const t = Math.min((now - startTime) / duration, 1);
      const ease = t < 0.5 ? 2 * t * t : -1 + (4 - 2 * t) * t;
      const invT = 1 - ease;
      const x = invT * invT * from.x + 2 * invT * ease * midX + ease * ease * to.x;
      const y = invT * invT * from.y + 2 * invT * ease * midY + ease * ease * to.y;
      env.style.left = x + 'px';
      env.style.top = y + 'px';
      env.style.opacity = t > 0.85 ? (1 - t) / 0.15 : Math.min(t / 0.1, 1);
      if (t < 1) requestAnimationFrame(animate);
      else { env.remove(); resolve(); }
    }
    requestAnimationFrame(animate);
  });
}

const MAX_LOG = 30;
const logEntries = document.getElementById('logEntries');

function addLog(icon, agentName, action) {
  const time = new Date().toTimeString().slice(0, 8);
  const entry = document.createElement('div');
  entry.className = 'log-entry';
  entry.innerHTML = `<span class="time">${time}</span>${icon} <span class="agent-name">${agentName}</span> <span class="action">${action}</span>`;
  logEntries.appendChild(entry);
  while (logEntries.children.length > MAX_LOG) logEntries.firstChild.remove();
  logEntries.scrollTop = logEntries.scrollHeight;
  // Mirror to mobile log area
  const mLog = document.getElementById('mobileLogArea');
  if (mLog) {
    if (mLog.children.length === 1 && !mLog.querySelector('.log-entry')) mLog.innerHTML = '';
    const clone = entry.cloneNode(true);
    mLog.appendChild(clone);
    while (mLog.children.length > MAX_LOG) mLog.firstChild.remove();
    mLog.scrollTop = mLog.scrollHeight;
  }
}

function agentName(id) { return AGENT_DISPLAY[id] || id; }

function handleLiveEvent(evt) {
  switch (evt.type) {
    case 'message_received':
      liveShowBubble(evt.from, 'æ”¶åˆ°ï¼š' + (evt.text || '').slice(0, 28));
      addLog('ğŸ’¬', agentName(evt.from), 'æ”¶åˆ°è¨Šæ¯ã€Œ' + (evt.text || '') + 'ã€');
      break;
    case 'thinking':
      liveSetStatus(evt.from, 'thinking');
      liveShowBubble(evt.from, 'ğŸ¤” æ€è€ƒä¸­<span class="thinking-dots"></span>', 'processing', 6000);
      addLog('ğŸ¤”', agentName(evt.from), 'æ€è€ƒä¸­...');
      break;
    case 'delegate':
      liveSetStatus(evt.from, 'thinking');
      liveShowBubble(evt.from, 'ğŸ“¨ åˆ†æ´¾ï¼š' + (evt.text || '').slice(0, 20), 'processing', 2000);
      addLog('âœ‰ï¸', agentName(evt.from), 'åˆ†æ´¾ä»»å‹™çµ¦ ' + agentName(evt.to) + 'ï¼š' + (evt.text || '').slice(0, 30));
      updateQueueBadge(evt.to, 1);
      setTimeout(() => {
        liveFlyEnvelope(evt.from, evt.to, evt.text?.slice(0, 15) || 'ä»»å‹™');
        liveSetStatus(evt.from, 'idle');
        liveSetStatus(evt.to, 'busy');
        liveShowBubble(evt.to, 'ğŸ“¥ æ”¶åˆ°ä»»å‹™ï¼', 'processing', 2000);
      }, 800);
      break;
    case 'task_received':
      liveSetStatus(evt.to || evt.from, 'busy');
      liveShowBubble(evt.to || evt.from, 'ğŸ“¥ æ”¶åˆ°ä»»å‹™ï¼');
      updateQueueBadge(evt.to || evt.from, 1);
      addLog('ğŸ“¥', agentName(evt.to || evt.from), 'æ”¶åˆ°ä»»å‹™');
      break;
    case 'processing':
      liveSetStatus(evt.from, 'busy');
      liveShowBubble(evt.from, 'âš™ï¸ è™•ç†ä¸­<span class="thinking-dots"></span>', 'processing', 8000);
      addLog('âš™ï¸', agentName(evt.from), 'è™•ç†ä¸­...');
      break;
    case 'task_complete':
      liveSetStatus(evt.from, 'idle');
      liveShowBubble(evt.from, 'âœ… å®Œæˆï¼', 'success', 3000);
      updateQueueBadge(evt.from, -1);
      addLog('âœ…', agentName(evt.from), 'å®Œæˆä»»å‹™');
      if (evt.to) {
        setTimeout(() => {
          liveFlyEnvelope(evt.from, evt.to, 'çµæœ');
          // Removed: addLog('âœ‰ï¸', agentName(evt.from), 'å›å‚³çµæœçµ¦ ' + agentName(evt.to));
        }, 500);
      }
      // Update cost counter
      setTimeout(loadCostCounter, 500);
      if (costDashboardOpen) setTimeout(renderCostDashboard, 800);
      break;
    case 'status_change':
      liveSetStatus(evt.from, evt.status || 'idle');
      addLog('ğŸ”µ', agentName(evt.from), 'ç‹€æ…‹ â†’ ' + (evt.status || 'idle'));
      break;
  }
}

/* ===== Agent Detail Panel ===== */
let currentPanelTab = 'detail';

function switchPanelTab(tab) {
  currentPanelTab = tab;
  document.querySelectorAll('.panel-tab').forEach(b => b.classList.toggle('active', b.dataset.tab === tab));
  document.getElementById('panelDetail').style.display = tab === 'detail' ? '' : 'none';
  document.getElementById('panelContent').style.display = tab === 'edit' ? '' : 'none';
}

// Map charId to agent API id (n8n_bot -> n8n-bot)
function charIdToAgentId(charId) {
  // charId (åƒç´ åœ– ID) â†’ agentId (è³‡æ–™åº« ID)
  const charToDbId = {
    'kevin': 7,
    'alex': 6,
    'lena': 8,
    'n8n_bot': 11,
    'writer': 14,
    'main': 10,
    'secguard': 12,
    'line-crm': 9
  };
  
  return charToDbId[charId] || charId;
}

const SKILL_ICONS = {
  'agent-management': 'ğŸ¯', 'task-dispatch': 'ğŸ“¨', 'communication': 'ğŸ’¬',
  'software-dev': 'ğŸ’»', 'api-design': 'ğŸ”Œ', 'debugging': 'ğŸ›', 'architecture': 'ğŸ—',
  'market-research': 'ğŸ“Š', 'ai-news': 'ğŸ¤–', 'data-analysis': 'ğŸ“ˆ',
  'social-media': 'ğŸ“±', 'copywriting': 'âœï¸', 'content-creation': 'ğŸ“',
  'n8n-workflow': 'âš™ï¸', 'automation': 'ğŸ”„', 'workflow-debug': 'ğŸ”§',
  'ai-compound': 'ğŸ§ª', 'compound-engineering': 'ğŸ—', 'n8n': 'âš™ï¸',
  'claude-code-specdriven': 'ğŸ¤–', 'ai-video-producer': 'ğŸ¬',
  'ai-explainer-producer': 'ğŸ“½', 'apify-social-scraper': 'ğŸ•·',
};

async function loadAgentDetail(charId) {
  const agentId = charIdToAgentId(charId);
  try {
    const res = await fetch(`/api/agents/${agentId}`);
    const data = await res.json();
    if (!data.ok) return;
    const agent = data.agent;

    document.getElementById('detailAvatar').src = agent.avatar || (PIXEL_AGENTS.has(charId) ? `assets/agents/${charId}_sw.png` : `assets/sloths/${charId}_sw.png`);
    document.getElementById('detailName').textContent = agent.name;
    document.getElementById('detailRole').textContent = agent.role;
    document.getElementById('detailDesc').textContent = agent.description || 'æš«ç„¡ç°¡ä»‹';

    // Skills
    const skillsEl = document.getElementById('detailSkills');
    skillsEl.innerHTML = '';
    (agent.skills || []).forEach(s => {
      const name = s.name || s;
      const icon = SKILL_ICONS[name] || 'ğŸ”¹';
      const pill = document.createElement('span');
      pill.className = 'skill-pill';
      pill.textContent = `${icon} ${s.description || name}`;
      skillsEl.appendChild(pill);
    });

    // Salary
    const salary = agent.monthly_salary || 30000;
    document.getElementById('detailSalary').textContent = `NT$ ${salary.toLocaleString()}`;
    document.getElementById('detailSalary').dataset.agentId = charIdToAgentId(charId);
    document.getElementById('detailSalary').dataset.salary = salary;

    // Tasks
    const tasksEl = document.getElementById('detailTasks');
    const tasks = agent.today_tasks || [];
    if (tasks.length === 0) {
      tasksEl.innerHTML = '<div style="color:#556677;font-size:12px;padding:4px 0">ä»Šæ—¥å°šç„¡ä»»å‹™</div>';
    } else {
      const summary = `<div style="color:#99aabb;font-size:12px;cursor:pointer;padding:4px 0" onclick="this.nextElementSibling.style.display=this.nextElementSibling.style.display==='none'?'':'none'">ğŸ“‹ ${tasks.length} ç­†ä»»å‹™ <span style="color:#556677">ï¼ˆé»æ“Šå±•é–‹ï¼‰</span></div>`;
      const details = tasks.map(t => {
        const time = t.started_at ? t.started_at.slice(11, 16) : '--:--';
        const taskName = t.task_name || t.task_summary || 'â€”';
        const hours = t.estimated_hours ? `${t.estimated_hours}h` : '';
        return `<div class="task-item"><span style="color:#556677">${time}</span> ${escHtml(taskName)} <span class="task-badge ${t.status}">${t.status}</span> <span style="color:#445566;font-size:10px">${hours}</span></div>`;
      }).join('');
      tasksEl.innerHTML = summary + `<div style="display:none">${details}</div>`;
    }

    // Stats
    document.getElementById('statToday').textContent = agent.stats?.today_completed || 0;
    document.getElementById('statWeek').textContent = agent.stats?.week_completed || 0;
    document.getElementById('statMonthSavings').textContent = `$${(agent.stats?.month_savings || 0).toLocaleString()}`;
  } catch (e) {
    console.error('Failed to load agent detail:', e);
  }
}

/* ===== Security Dashboard ===== */
function scrollToSecSection(id) {
  const el = document.getElementById(id);
  if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

async function loadSecurityDashboard() {
  try {
    const res = await fetch('/api/security/status');
    const data = await res.json();
    if (!data.ok) return;

    // Health score
    const score = data.score ?? 100;
    const risk = data.risk_level || 'safe';
    document.getElementById('secScore').textContent = score;
    const dot = document.getElementById('secHealthDot');
    dot.style.background = risk === 'safe' ? '#2ecc71' : risk === 'warning' ? '#f1c40f' : '#e74c3c';
    dot.style.boxShadow = `0 0 20px ${risk === 'safe' ? '#2ecc7155' : risk === 'warning' ? '#f1c40f55' : '#e74c3c55'}`;

    // Stats
    const s = data.stats || {};
    document.getElementById('statScansToday').textContent = s.scans_today || 0;
    document.getElementById('statThreatsToday').textContent = s.threats_today || 0;
    document.getElementById('statBlocksToday').textContent = s.blocks_today || 0;

    // Port scan from latest scan
    const scan = data.latest_scan?.result?.scans?.ports;
    const portTable = document.getElementById('secPortTable');
    const portEmpty = document.getElementById('secPortEmpty');
    if (scan && scan.length) {
      portEmpty.style.display = 'none';
      portTable.innerHTML = scan.map(p => {
        const color = p.status === 'safe' ? '#2ecc71' : p.status === 'warning' ? '#f1c40f' : '#e74c3c';
        const badge = `<span style="color:${color};font-weight:600">${p.status === 'safe' ? 'ğŸŸ¢' : p.status === 'warning' ? 'ğŸŸ¡' : 'ğŸ”´'} ${p.status}</span>`;
        return `<tr style="border-bottom:1px solid #0a0f1a"><td style="padding:8px">${p.port || '-'}</td><td style="padding:8px">${p.service || '-'}</td><td style="padding:8px;font-size:11px">${p.address || '-'}</td><td style="padding:8px">${badge}</td></tr>`;
      }).join('');
    }

    // Alerts
    const alertsEl = document.getElementById('secAlerts');
    if (data.alerts && data.alerts.length) {
      alertsEl.innerHTML = data.alerts.map(a => {
        const color = a.severity === 'danger' ? '#e74c3c' : '#f1c40f';
        return `<div style="padding:8px;border-bottom:1px solid #0a0f1a"><span style="color:${color};font-weight:600">${a.severity === 'danger' ? 'ğŸ”´' : 'ğŸŸ¡'}</span> <span style="color:#556677;font-size:11px">${a.created_at || ''}</span> ${a.description || ''}</div>`;
      }).join('');
    }

    // Load prompts
    const pRes = await fetch('/api/security/prompts');
    const pData = await pRes.json();
    renderPromptTable(pData.prompts || []);
  } catch (e) {
    console.error('Failed to load security dashboard:', e);
  }
}

function renderPromptTable(prompts) {
  const table = document.getElementById('secPromptTable');
  const empty = document.getElementById('secPromptEmpty');
  if (prompts.length) {
    empty.style.display = 'none';
    table.innerHTML = prompts.slice(0, 20).map(p => {
      const color = p.threat_level === 'safe' ? '#2ecc71' : p.threat_level === 'warning' ? '#f1c40f' : '#e74c3c';
      const badge = `<span style="color:${color};font-weight:600">${p.threat_level}</span>`;
      const actionBadge = p.action === 'block' ? '<span style="color:#e74c3c">ğŸš« block</span>' : p.action === 'flag' ? '<span style="color:#f1c40f">âš ï¸ flag</span>' : '<span style="color:#2ecc71">âœ… allow</span>';
      return `<tr style="border-bottom:1px solid #0a0f1a"><td style="padding:8px;font-size:11px;color:#556677">${(p.reviewed_at || '').slice(11,19)}</td><td style="padding:8px">${p.source || '-'}</td><td style="padding:8px;max-width:300px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${escHtml(p.message_preview || '')}</td><td style="padding:8px">${badge}</td><td style="padding:8px">${actionBadge}</td></tr>`;
    }).join('');
  } else {
    empty.style.display = '';
    table.innerHTML = '';
  }
}

async function runSecurityScan() {
  try {
    const res = await fetch('/api/security/scan', { method: 'POST' });
    const data = await res.json();
    if (data.ok) loadSecurityDashboard();
  } catch (e) { console.error(e); }
}

async function testPromptInjection() {
  const input = document.getElementById('secPromptInput');
  const text = input.value.trim();
  if (!text) return;
  try {
    const res = await fetch('/api/security/check-prompt', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ text, source: 'dashboard-test' }),
    });
    const data = await res.json();
    if (data.ok) {
      input.value = '';
      loadSecurityDashboard();
      const r = data.result;
      const emoji = r.safe ? 'âœ…' : r.threat_level === 'warning' ? 'âš ï¸' : 'ğŸš«';
      alert(`${emoji} ${r.threat_level.toUpperCase()}\n${r.matched_rules.length ? 'Rules: ' + r.matched_rules.join(', ') : 'No threats detected'}`);
    }
  } catch (e) { console.error(e); }
}

/* ===== Cost Dashboard ===== */
let costDashboardOpen = false;
let currentCostData = null;

function animateValue(el, start, end, duration = 800) {
  const range = end - start;
  const startTime = performance.now();
  function step(now) {
    const t = Math.min((now - startTime) / duration, 1);
    const ease = t < 0.5 ? 2*t*t : -1+(4-2*t)*t;
    el.textContent = Math.round(start + range * ease).toLocaleString();
    if (t < 1) requestAnimationFrame(step);
  }
  requestAnimationFrame(step);
}

async function loadCostCounter() {
  try {
    const res = await fetch('/api/dashboard/costs');
    const data = await res.json();
    if (!data.ok) return;
    currentCostData = data;
    const el = document.getElementById('costCounterValue');
    const oldVal = parseInt(el.textContent.replace(/,/g, '')) || 0;
    animateValue(el, oldVal, data.total_savings);
  } catch(e) { console.error('Cost counter error:', e); }
}

function openCostDashboard() {
  costDashboardOpen = true;
  document.getElementById('costDashboardModal').classList.add('active');
  renderCostDashboard();
}

function closeCostDashboard() {
  costDashboardOpen = false;
  document.getElementById('costDashboardModal').classList.remove('active');
}

async function renderCostDashboard() {
  try {
    const res = await fetch('/api/dashboard/costs');
    const data = await res.json();
    if (!data.ok) return;
    currentCostData = data;

    // Top cards
    const avgDaily = data.month_tasks > 0 ? Math.round(data.month_tasks / new Date().getDate()) : 0;
    document.getElementById('costCards').innerHTML = `
      <div class="cost-card"><div class="big">NT$ ${data.total_savings.toLocaleString()}</div><div class="label">ç¸½ç¯€çœé‡‘é¡</div></div>
      <div class="cost-card"><div class="big">${data.equiv_employees}</div><div class="label">ç­‰åŒå…¨è·å“¡å·¥</div></div>
      <div class="cost-card"><div class="big">${data.month_tasks}</div><div class="label">æœ¬æœˆä»»å‹™ç¸½æ•¸</div></div>
      <div class="cost-card"><div class="big">${avgDaily}</div><div class="label">å¹³å‡æ¯æ—¥ä»»å‹™</div></div>
    `;

    // Agent table (åˆ†é¡é¡¯ç¤ºï¼šä»»å‹™/æ’ç¨‹/ç›£æ§)
    document.getElementById('costTableBody').innerHTML = data.agents.map(a =>
      `<tr><td>${escHtml(a.name)} <span style="color:#556677;font-size:11px">${escHtml(a.role||'')}</span></td><td>${a.tasks_completed||0}</td><td>${a.tasks_cron||0}</td><td>${a.tasks_monitoring||0}</td><td style="color:#f0a500;font-weight:600">NT$ ${a.savings.toLocaleString()}</td><td>${a.total_hours}h</td><td style="color:#556677">NT$ ${(a.monthly_salary||30000).toLocaleString()}</td></tr>`
    ).join('');

    // Trend chart
    const maxSavings = Math.max(...data.trend.map(t => t.savings), 1);
    document.getElementById('costChart').innerHTML = data.trend.map(t => {
      const h = Math.max((t.savings / maxSavings) * 120, 2);
      const day = t.date.slice(5);
      return `<div class="cost-bar-col"><div class="cost-bar-val">${t.tasks}</div><div class="cost-bar" style="height:${h}px"></div><div class="cost-bar-label">${day}</div></div>`;
    }).join('');

    // Fun metrics
    const mvpName = data.mvp ? (data.agents.find(a=>a.id===data.mvp.agent_id)?.name || data.mvp.agent_id) : 'â€”';
    document.getElementById('funMetrics').innerHTML = `
      <div class="fun-card"><div class="fun-icon">ğŸ†</div>æœ¬é€± MVP<div class="fun-val">${escHtml(mvpName)}${data.mvp ? ` (${data.mvp.tasks} ä»»å‹™)` : ''}</div></div>
      <div class="fun-card"><div class="fun-icon">ğŸ’¡</div>å¦‚æœä¸ç”¨ AIï¼Œä½ éœ€è¦é¡å¤–é›‡ç”¨<div class="fun-val">${data.equiv_employees} äºº</div></div>
      <div class="fun-card"><div class="fun-icon">ğŸ“Š</div>AI å“¡å·¥æ•ˆç‡<div class="fun-val">24/7 å…¨å¹´ç„¡ä¼‘</div></div>
      <div class="fun-card"><div class="fun-icon">âš¡</div>æœ¬æœˆä»»å‹™ç¸½é‡<div class="fun-val">${data.month_tasks} ç­†</div></div>
    `;
  } catch(e) { console.error('Cost dashboard error:', e); }
}

// Salary inline edit
function startSalaryEdit() {
  const el = document.getElementById('detailSalary');
  const agentId = el.dataset.agentId;
  const salary = parseInt(el.dataset.salary) || 30000;
  el.innerHTML = `<input class="salary-edit" type="number" value="${salary}" id="salaryInput">`;
  const input = document.getElementById('salaryInput');
  input.focus();
  input.select();
  const save = async () => {
    const val = parseInt(input.value) || 30000;
    try {
      await fetch(`/api/agents/${agentId}/salary`, {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({monthly_salary: val}),
      });
    } catch(e) {}
    el.textContent = `NT$ ${val.toLocaleString()}`;
    el.dataset.salary = val;
  };
  input.addEventListener('blur', save);
  input.addEventListener('keydown', e => { if (e.key === 'Enter') input.blur(); });
}

// Dashboard tab switching
function switchDashTab(el) {
  document.querySelectorAll('.dash-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.dash-panel').forEach(p => p.classList.remove('active'));
  el.classList.add('active');
  document.getElementById(el.dataset.panel).classList.add('active');
  // Load data for panel
  if (el.dataset.panel === 'engagePanel') renderEngageDashboard();
  if (el.dataset.panel === 'thoughtPanel') renderThoughtPanel();
}

// Engagement dashboard
async function renderEngageDashboard() {
  try {
    const res = await fetch('/api/dashboard/engagement');
    const data = await res.json();
    if (!data.ok) return;

    // Top cards
    const g = data.global_today;
    const gw = data.global_week;
    const ru = data.real_token_usage || {input: 0, output: 0, total: 0, cost_usd: 0};
    document.getElementById('engageCards').innerHTML = `
      <div class="engage-card"><div class="big">${g.conversations}</div><div class="label">ä»Šæ—¥å°è©±</div></div>
      <div class="engage-card"><div class="big">${ru.total.toLocaleString()}</div><div class="label">ä»Šæ—¥ Tokenï¼ˆå¯¦éš›ï¼‰</div></div>
      <div class="engage-card"><div class="big">$${ru.cost_usd.toFixed(2)}</div><div class="label">ä»Šæ—¥ API èŠ±è²»</div></div>
    `;

    // Real usage breakdown
    const ruSection = document.getElementById('realUsageSection');
    if (ru.total > 0) {
      ruSection.innerHTML = `
        <div style="background:#0d1525;border:1px solid #1a3a5c;border-radius:12px;padding:16px;display:flex;gap:24px;flex-wrap:wrap">
          <div style="flex:1;min-width:120px"><div style="font-size:11px;color:#556677">Input Tokens</div><div style="font-size:18px;font-weight:700;color:#4ecdc4">${ru.input.toLocaleString()}</div></div>
          <div style="flex:1;min-width:120px"><div style="font-size:11px;color:#556677">Output Tokens</div><div style="font-size:18px;font-weight:700;color:#f0a500">${ru.output.toLocaleString()}</div></div>
          <div style="flex:1;min-width:120px"><div style="font-size:11px;color:#556677">Cache Read</div><div style="font-size:18px;font-weight:700;color:#99aabb">${(ru.total - ru.input - ru.output).toLocaleString()}</div></div>
          <div style="flex:1;min-width:120px"><div style="font-size:11px;color:#556677">API èŠ±è²» (USD)</div><div style="font-size:18px;font-weight:700;color:#e74c3c">$${ru.cost_usd.toFixed(4)}</div></div>
        </div>`;
    } else {
      ruSection.innerHTML = '<div style="background:#0d1525;border:1px solid #1a3a5c;border-radius:12px;padding:16px;text-align:center;color:#556677;font-size:13px">â³ å°šç„¡ Clawdbot å¯¦éš› Token æ•¸æ“š â€” æ•¸æ“šæœƒåœ¨ agent åŸ·è¡Œä»»å‹™æ™‚è‡ªå‹•æ¨é€</div>';
    }

    // Per-agent table
    document.getElementById('engageTableBody').innerHTML = data.agents.map(a => {
      const rt = a.real_tokens || {total: 0, cost_usd: 0};
      return `<tr><td>${escHtml(a.name)}</td><td>${a.today.conversations}</td><td>${rt.total > 0 ? rt.total.toLocaleString() : '<span style="color:#556677">â€”</span>'}</td><td>${rt.cost_usd > 0 ? '$' + rt.cost_usd.toFixed(4) : '<span style="color:#556677">â€”</span>'}</td><td>${a.today.tasks_completed}</td></tr>`;
    }).join('');

    // Weekly trend chart (conversations)
    const days = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
    const allTrends = data.agents.flatMap(a => a.trend.map(t => t.conversations));
    const maxConvo = Math.max(...allTrends, 1);
    // Aggregate by day
    const dayTotals = Array(7).fill(0);
    data.agents.forEach(a => a.trend.forEach((t, i) => dayTotals[i] += t.conversations));
    const maxDay = Math.max(...dayTotals, 1);
    document.getElementById('engageChart').innerHTML = dayTotals.map((v, i) => {
      const h = Math.max((v / maxDay) * 120, 2);
      const d = new Date(); d.setDate(d.getDate() - (6 - i));
      return `<div class="cost-bar-col"><div class="cost-bar-val">${v}</div><div class="cost-bar" style="height:${h}px;background:linear-gradient(180deg,#4ecdc4,#2a9d8f)"></div><div class="cost-bar-label">${d.getMonth()+1}/${d.getDate()}</div></div>`;
    }).join('');
  } catch(e) { console.error('Engage dashboard error:', e); }
}

// Thought panel
async function renderThoughtPanel() {
  try {
    const res = await fetch('/api/dashboard/engagement');
    const data = await res.json();
    if (!data.ok) return;

    document.getElementById('thoughtGrid').innerHTML = data.agents.map(a => {
      const charId = a.id === 'n8n-bot' ? 'n8n_bot' : a.id;
      const avatarSrc = `assets/agents/${charId}_sw.png`;
      const mood = a.today.errors >= 3 ? 'ğŸ˜°' : a.today.praises >= 2 ? 'ğŸ˜Š' : a.today.tasks_completed >= 5 ? 'ğŸ’ª' : a.today.conversations === 0 ? 'ğŸ˜´' : 'ğŸ™‚';
      return `
        <div class="thought-card">
          <div style="display:flex;align-items:center;gap:10px">
            <img class="thought-avatar" src="${avatarSrc}" onerror="this.src='assets/sloths/${charId}_sw.png'">
            <div>
              <div style="font-weight:700;color:#e8d5b7">${escHtml(a.name)} ${mood}</div>
              <div style="font-size:11px;color:#556677">${escHtml(a.role || '')}</div>
            </div>
          </div>
          <div class="thought-bubble">${escHtml(a.inner_thought)}</div>
          <div class="thought-stats">
            <div class="thought-stat">ğŸ’¬ <span>${a.today.conversations}</span> å°è©±</div>
            <div class="thought-stat">âœ… <span>${a.today.tasks_completed}</span> å®Œæˆ</div>
            <div class="thought-stat">ğŸ“ <span>${a.today.words.toLocaleString()}</span> å­—</div>
            <div class="thought-stat">ğŸ”¤ <span>${a.today.tokens.toLocaleString()}</span> token</div>
          </div>
        </div>`;
    }).join('');
  } catch(e) { console.error('Thought panel error:', e); }
}

// Close cost dashboard on overlay click
document.getElementById('costDashboardModal').addEventListener('click', e => {
  if (e.target === document.getElementById('costDashboardModal')) closeCostDashboard();
});

// Load cost counter on init
setTimeout(loadCostCounter, 1000);
// Refresh every 60s
setInterval(loadCostCounter, 60000);

/* ===== SSE Connection ===== */
let evtSource = null;

let SSE_TOKEN = null;

async function initSSE() {
  try {
    const res = await fetch('/api/token');
    const data = await res.json();
    SSE_TOKEN = data.token;
    connectSSE();
  } catch (error) {
    console.error('Failed to get SSE token:', error);
    setTimeout(initSSE, 3000);
  }
}

function connectSSE() {
  if (!SSE_TOKEN) {
    setTimeout(connectSSE, 1000);
    return;
  }
  
  const badge = document.getElementById('liveBadge');
  const label = document.getElementById('liveLabel');
  
  evtSource = new EventSource(`/api/animation/stream?token=${SSE_TOKEN}`);
  
  evtSource.onopen = () => {
    badge.classList.add('connected');
    label.textContent = 'LIVE';
    addLog('ğŸŸ¢', 'System', 'SSE é€£ç·šæˆåŠŸ');
  };
  
  evtSource.onmessage = (e) => {
    try {
      const data = JSON.parse(e.data);
      handleLiveEvent(data);
    } catch (_) {}
  };
  
  evtSource.onerror = () => {
    badge.classList.remove('connected');
    label.textContent = 'OFFLINE';
    evtSource.close();
    setTimeout(connectSSE, 3000);
  };
}

function toggleLogPanel() {
  document.getElementById('logPanel').classList.toggle('collapsed');
}
window.toggleLogPanel = toggleLogPanel;

/* ===== Demo ===== */
document.getElementById('btnDemo').addEventListener('click', async () => {
  const btn = document.getElementById('btnDemo');
  btn.disabled = true;
  btn.textContent = 'ğŸ¬ Running...';
  
  // Expand log panel
  document.getElementById('logPanel').classList.remove('collapsed');
  
  const delay = ms => new Promise(r => setTimeout(r, ms));

  handleLiveEvent({ type: 'message_received', from: 'kevin', text: 'å¹«æˆ‘å¯«ä¸€å€‹ REST API' });
  await delay(2000);
  handleLiveEvent({ type: 'status_change', from: 'kevin', status: 'thinking' });
  await delay(1500);
  handleLiveEvent({ type: 'delegate', from: 'kevin', to: 'alex', text: 'å¯« REST API' });
  await delay(2500);
  handleLiveEvent({ type: 'task_received', from: 'alex', to: 'alex' });
  await delay(1500);
  handleLiveEvent({ type: 'processing', from: 'alex' });
  await delay(3000);
  handleLiveEvent({ type: 'delegate', from: 'kevin', to: 'writer', text: 'å¯« API æ–‡ä»¶' });
  await delay(2500);
  handleLiveEvent({ type: 'task_received', from: 'writer', to: 'writer' });
  await delay(1000);
  handleLiveEvent({ type: 'processing', from: 'writer' });
  await delay(2500);
  handleLiveEvent({ type: 'task_complete', from: 'writer', to: 'kevin' });
  await delay(2000);
  handleLiveEvent({ type: 'task_complete', from: 'alex', to: 'kevin' });
  await delay(2000);
  handleLiveEvent({ type: 'message_received', from: 'kevin', text: 'å·²å®Œæˆï¼šREST API + æ–‡ä»¶' });
  handleLiveEvent({ type: 'status_change', from: 'kevin', status: 'idle' });

  btn.disabled = false;
  btn.textContent = 'ğŸ¬ Demo';
});

/* ===== Start SSE ===== */
initSSE();
</script>
</body>
</html>
