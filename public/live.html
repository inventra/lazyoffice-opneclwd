<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ÂÅ∑Êá∂Ëæ¶ÂÖ¨ÂÆ§ ‚Äî Lazy Office Live</title>
<style>
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

:root {
  --bg-dark: #0a0a1a;
  --bg-panel: #16213e;
  --bg-header: linear-gradient(135deg, #16213e, #0f1a30);
  --text-primary: #e8d5b7;
  --text-secondary: #667788;
  --accent: #f0a500;
  --border: #1a3a5c;
  --green: #00e676;
  --yellow: #ffc107;
  --red: #ff5252;
  --bubble-bg: rgba(255,255,255,0.95);
  --bubble-text: #1a1a2e;
  --envelope-color: #f0a500;
}

html, body {
  height: 100%;
  overflow: hidden;
  background: var(--bg-dark);
  color: var(--text-primary);
  font-family: "Segoe UI", "PingFang TC", "Microsoft JhengHei", sans-serif;
}

/* === LAYOUT === */
#app {
  display: flex;
  flex-direction: column;
  height: 100vh;
}

header {
  background: var(--bg-header);
  border-bottom: 1px solid var(--border);
  padding: 12px 24px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-shrink: 0;
}

header h1 {
  font-size: 18px;
  font-weight: 600;
  letter-spacing: 0.5px;
}

header h1 span { color: var(--accent); }

.live-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  background: rgba(255,82,82,0.15);
  border: 1px solid rgba(255,82,82,0.3);
  border-radius: 20px;
  padding: 4px 14px;
  font-size: 12px;
  font-weight: 600;
  color: var(--red);
  letter-spacing: 1px;
}

.live-dot {
  width: 8px; height: 8px;
  background: var(--red);
  border-radius: 50%;
  animation: livePulse 1.5s ease-in-out infinite;
}

@keyframes livePulse {
  0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(255,82,82,0.6); }
  50% { opacity: 0.7; box-shadow: 0 0 0 6px rgba(255,82,82,0); }
}

.header-actions {
  display: flex;
  align-items: center;
  gap: 10px;
}

.btn {
  background: rgba(255,255,255,0.06);
  border: 1px solid var(--border);
  color: var(--text-primary);
  padding: 6px 16px;
  border-radius: 6px;
  font-size: 13px;
  cursor: pointer;
  transition: all 0.2s;
}
.btn:hover { background: rgba(255,255,255,0.12); border-color: var(--accent); }

.sse-status {
  font-size: 11px;
  display: flex;
  align-items: center;
  gap: 5px;
}

.sse-dot {
  width: 6px; height: 6px;
  border-radius: 50%;
  background: var(--text-secondary);
  transition: background 0.3s;
}

.sse-dot.connected { background: var(--green); }
.sse-dot.disconnected { background: var(--red); }

/* === CANVAS === */
.canvas-wrap {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 16px;
  overflow: hidden;
  min-height: 0;
}

.canvas {
  position: relative;
  max-width: 100%;
  max-height: 100%;
  border-radius: 8px;
  box-shadow: 0 8px 40px rgba(0,0,0,.6), 0 0 0 1px rgba(255,255,255,.05);
  overflow: hidden;
  aspect-ratio: 2752 / 1536;
}

.canvas img.bg {
  display: block;
  width: 100%;
  height: 100%;
  object-fit: cover;
  pointer-events: none;
  user-select: none;
}

/* === AGENTS === */
.agent {
  position: absolute;
  transform: translate(-50%, -50%);
  cursor: default;
  user-select: none;
  transition: filter 0.3s;
}

.agent.react {
  animation: agentJump 0.5s ease;
}

.agent.idle-bob {
  animation: idleBob 3s ease-in-out infinite;
}

@keyframes agentJump {
  0% { transform: translate(-50%, -50%); }
  30% { transform: translate(-50%, calc(-50% - 12px)); }
  50% { transform: translate(-50%, -50%); }
  70% { transform: translate(-50%, calc(-50% - 5px)); }
  100% { transform: translate(-50%, -50%); }
}

@keyframes idleBob {
  0%, 100% { transform: translate(-50%, -50%); }
  50% { transform: translate(-50%, calc(-50% - 2px)); }
}

.agent img {
  width: 100%;
  height: auto;
  pointer-events: none;
  filter: drop-shadow(0 4px 8px rgba(0,0,0,0.4));
}

.agent-label {
  position: absolute;
  bottom: -28px;
  left: 50%;
  transform: translateX(-50%);
  white-space: nowrap;
  font-size: 13px;
  font-weight: 700;
  color: #fff;
  background: rgba(10, 10, 26, 0.75);
  padding: 3px 10px 2px;
  border-radius: 6px;
  border: 1px solid rgba(240, 165, 0, 0.3);
  text-shadow: 0 1px 3px rgba(0,0,0,1);
  pointer-events: none;
  backdrop-filter: blur(4px);
  -webkit-backdrop-filter: blur(4px);
}

.agent-role {
  font-size: 10px;
  font-weight: 500;
  color: rgba(255,255,255,0.6);
  display: block;
  text-align: center;
  margin-top: 2px;
}

/* === STATUS DOT === */
.status-dot {
  position: absolute;
  top: -4px;
  right: -4px;
  width: 12px; height: 12px;
  border-radius: 50%;
  border: 2px solid rgba(0,0,0,0.4);
  background: var(--green);
  transition: background 0.3s;
  z-index: 10;
}

.status-dot.thinking {
  background: var(--yellow);
  box-shadow: 0 0 8px var(--yellow), 0 0 16px rgba(255,193,7,0.4);
  animation: statusPulse 1s ease-in-out infinite;
}

.status-dot.busy {
  background: var(--red);
  box-shadow: 0 0 8px var(--red), 0 0 16px rgba(255,82,82,0.4);
  animation: statusPulse 0.6s ease-in-out infinite;
}

@keyframes statusPulse {
  0%, 100% { transform: scale(1); opacity: 1; }
  50% { transform: scale(1.4); opacity: 0.7; }
}

/* === CHAT BUBBLE === */
.chat-bubble {
  position: absolute;
  bottom: calc(100% + 12px);
  left: 50%;
  transform: translateX(-50%) scale(0);
  background: var(--bubble-bg);
  color: var(--bubble-text);
  padding: 8px 14px;
  border-radius: 12px;
  border-bottom-left-radius: 4px;
  font-size: 13px;
  font-weight: 500;
  white-space: nowrap;
  max-width: 220px;
  overflow: hidden;
  text-overflow: ellipsis;
  box-shadow: 0 4px 20px rgba(0,0,0,0.3), 0 0 0 1px rgba(255,255,255,0.1);
  z-index: 100;
  pointer-events: none;
  animation: bubbleLife 4s ease forwards;
}

.chat-bubble::after {
  content: '';
  position: absolute;
  bottom: -6px;
  left: 16px;
  width: 12px; height: 12px;
  background: var(--bubble-bg);
  clip-path: polygon(0 0, 100% 0, 0 100%);
}

.chat-bubble.processing {
  background: rgba(255,193,7,0.3);
  color: #fff;
  border: 1px solid rgba(255,193,7,0.6);
  box-shadow: 0 4px 20px rgba(255,193,7,0.3), 0 0 12px rgba(255,193,7,0.2);
  font-weight: 600;
}

.chat-bubble.processing::after {
  background: rgba(255,193,7,0.3);
}

.chat-bubble.success {
  background: rgba(0,230,118,0.15);
  color: var(--green);
  border: 1px solid rgba(0,230,118,0.3);
}

.chat-bubble.success::after {
  background: rgba(0,230,118,0.15);
}

.spinner {
  display: inline-block;
  width: 12px; height: 12px;
  border: 2px solid var(--yellow);
  border-top-color: transparent;
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  vertical-align: middle;
  margin-right: 4px;
}

@keyframes spin { to { transform: rotate(360deg); } }

@keyframes bubbleLife {
  0% { transform: translateX(-50%) scale(0); opacity: 0; }
  8% { transform: translateX(-50%) scale(1.08); opacity: 1; }
  12% { transform: translateX(-50%) scale(1); opacity: 1; }
  75% { transform: translateX(-50%) scale(1) translateY(0); opacity: 1; }
  85% { transform: translateX(-50%) scale(1) translateY(-4px); opacity: 0.8; }
  100% { transform: translateX(-50%) scale(0.9) translateY(-8px); opacity: 0; }
}

/* === ENVELOPE === */
.envelope {
  position: absolute;
  z-index: 200;
  pointer-events: none;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 2px;
}

.envelope-icon {
  font-size: 28px;
  filter: drop-shadow(0 2px 8px rgba(240,165,0,0.5));
  animation: envelopeWobble 0.3s ease-in-out infinite alternate;
}

.envelope-label {
  font-size: 10px;
  color: var(--accent);
  background: rgba(10,10,26,0.8);
  padding: 2px 8px;
  border-radius: 8px;
  white-space: nowrap;
  max-width: 120px;
  overflow: hidden;
  text-overflow: ellipsis;
}

@keyframes envelopeWobble {
  from { transform: rotate(-5deg) translateY(-2px); }
  to { transform: rotate(5deg) translateY(2px); }
}

/* === ACTIVITY LOG === */
.activity-log {
  flex-shrink: 0;
  height: 140px;
  background: linear-gradient(180deg, #0d1525, #0a0a1a);
  border-top: 1px solid var(--border);
  padding: 10px 20px;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

.activity-log h3 {
  font-size: 12px;
  color: var(--text-secondary);
  margin-bottom: 6px;
  flex-shrink: 0;
}

.log-entries {
  flex: 1;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 3px;
}

.log-entries::-webkit-scrollbar { width: 5px; }
.log-entries::-webkit-scrollbar-track { background: transparent; }
.log-entries::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

.log-entry {
  font-size: 12px;
  color: var(--text-secondary);
  line-height: 1.5;
  animation: logSlideIn 0.3s ease;
}

.log-entry .time { color: #445566; margin-right: 8px; font-size: 11px; }
.log-entry .agent-name { color: var(--accent); font-weight: 600; }
.log-entry .action { color: var(--text-primary); }

@keyframes logSlideIn {
  from { opacity: 0; transform: translateY(8px); }
  to { opacity: 1; transform: translateY(0); }
}

@keyframes sparkFade {
  0% { opacity: 1; transform: translateX(-50%) scale(0.5); }
  50% { opacity: 1; transform: translateX(-50%) scale(1.2); }
  100% { opacity: 0; transform: translateX(-50%) scale(0.8) translateY(-20px); }
}

.log-entry.success { color: var(--green); }
.log-entry.error { color: var(--red); }

/* === EDIT MODE === */
.edit-panel {
  position: fixed;
  top: 0; right: -340px;
  width: 320px;
  height: 100vh;
  background: #111827;
  border-left: 1px solid var(--border);
  z-index: 500;
  transition: right 0.3s ease;
  display: flex;
  flex-direction: column;
  box-shadow: -4px 0 24px rgba(0,0,0,0.5);
}
.edit-panel.open { right: 0; }

.edit-panel-header {
  padding: 14px 16px;
  border-bottom: 1px solid var(--border);
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.edit-panel-header h3 { font-size: 14px; color: var(--accent); }
.edit-panel-close {
  background: none; border: none; color: var(--text-secondary);
  font-size: 18px; cursor: pointer;
}

.edit-panel-body {
  flex: 1;
  overflow-y: auto;
  padding: 12px 16px;
}

.edit-agent-card {
  background: rgba(255,255,255,0.04);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 12px;
  margin-bottom: 10px;
}
.edit-agent-card.selected {
  border-color: var(--accent);
  background: rgba(240,165,0,0.08);
}
.edit-agent-card h4 {
  font-size: 13px; margin-bottom: 8px; color: var(--text-primary);
}
.edit-row {
  display: flex; gap: 8px; margin-bottom: 6px; align-items: center;
}
.edit-row label {
  font-size: 11px; color: var(--text-secondary); width: 32px; flex-shrink: 0;
}
.edit-row input[type="range"] {
  flex: 1; accent-color: var(--accent);
}
.edit-row .val {
  font-size: 11px; color: var(--accent); width: 36px; text-align: right;
}
.edit-dir-btns { display: flex; gap: 4px; flex-wrap: wrap; }
.edit-dir-btns button {
  background: rgba(255,255,255,0.06);
  border: 1px solid var(--border);
  color: var(--text-primary);
  padding: 3px 8px; border-radius: 4px;
  font-size: 11px; cursor: pointer;
}
.edit-dir-btns button.active {
  background: var(--accent); color: #000; border-color: var(--accent);
}

.edit-panel-footer {
  padding: 12px 16px;
  border-top: 1px solid var(--border);
  display: flex; gap: 8px;
}
.edit-panel-footer button {
  flex: 1; padding: 8px; border-radius: 6px;
  font-size: 12px; font-weight: 600; cursor: pointer; border: none;
}
.btn-export { background: var(--accent); color: #000; }
.btn-reset { background: rgba(255,255,255,0.08); color: var(--text-primary); border: 1px solid var(--border) !important; }

body.edit-mode .agent { cursor: grab; }
body.edit-mode .agent:active { cursor: grabbing; }
body.edit-mode .agent.dragging { z-index: 999 !important; filter: brightness(1.3); }
</style>
</head>
<body>
<div id="app">
  <header>
    <h1><span>ÂÅ∑Êá∂Ëæ¶ÂÖ¨ÂÆ§</span> ‚Äî Lazy Office</h1>
    <div class="header-actions">
      <div class="sse-status">
        <div class="sse-dot" id="sseDot"></div>
        <span id="sseLabel">Disconnected</span>
      </div>
      <button class="btn" id="btnDemo">Demo</button>
      <button class="btn" id="btnEdit">‚úèÔ∏è Edit</button>
    </div>
    <div class="live-badge"><div class="live-dot"></div>LIVE</div>
  </header>

  <div class="canvas-wrap">
    <div class="canvas" id="canvas">
      <img class="bg" src="assets/offices/default_v2.jpg" alt="Office">
    </div>
  </div>

  <!-- Edit Panel -->
  <div class="edit-panel" id="editPanel">
    <div class="edit-panel-header">
      <h3>‚úèÔ∏è Agent Á∑®ËºØÂô®</h3>
      <button class="edit-panel-close" id="editClose">‚úï</button>
    </div>
    <div class="edit-panel-body" id="editBody"></div>
    <div class="edit-panel-footer">
      <button class="btn-reset" id="btnReset">ÈáçÁΩÆ</button>
      <button class="btn-export" id="btnExport">Ë§áË£ΩË®≠ÂÆö</button>
    </div>
  </div>

  <div class="activity-log">
    <h3>Activity Log</h3>
    <div class="log-entries" id="logEntries"></div>
  </div>
</div>

<script>
// === AGENT DATA ===
const AGENTS = {
  kevin:   { name: 'Kevin Â∞èÂπ´Êâã', role: 'Ë®äÊÅØË™øÂ∫¶‰∏≠ÂøÉ üëë', x: 25, y: 65, dir: 'se' },
  alex:    { name: 'Alex', role: 'Â∑•Á®ãÂ∏´ üíª', x: 55, y: 40, dir: 'sw' },
  lena:    { name: 'Lena', role: 'Âä©ÁêÜ üìã', x: 40, y: 30, dir: 'sw' },
  writer:  { name: 'Writer', role: 'ÂØ´ÊñáÂ∞àÂÆ∂ ‚úçÔ∏è', x: 65, y: 60, dir: 'sw' },
  n8n_bot: { name: 'N8N Bot', role: 'Ëá™ÂãïÂåñÂ∞àÂÆ∂ ‚öôÔ∏è', x: 80, y: 45, dir: 'sw' },
};

const canvas = document.getElementById('canvas');
const logEntries = document.getElementById('logEntries');
const agentEls = {};
const MAX_LOG = 20;

// === RENDER AGENTS ===
Object.entries(AGENTS).forEach(([id, agent]) => {
  const el = document.createElement('div');
  el.className = 'agent';
  el.style.left = agent.x + '%';
  el.style.top = agent.y + '%';
  el.style.width = '7%';
  el.style.zIndex = Math.round(agent.y);
  el.innerHTML = `
    <div class="status-dot" data-agent="${id}"></div>
    <img src="assets/agents/${id}_${agent.dir}.png" alt="${agent.name}">
    <div class="agent-label">${agent.name}<span class="agent-role">${agent.role}</span></div>
  `;
  canvas.appendChild(el);
  agentEls[id] = el;
});

// === ANIMATION ENGINE ===

function getAgentCenter(agentId) {
  const a = AGENTS[agentId];
  const rect = canvas.getBoundingClientRect();
  return {
    x: (a.x / 100) * rect.width,
    y: (a.y / 100) * rect.height - 30
  };
}

function showBubble(agentId, text, cssClass, duration) {
  const el = agentEls[agentId];
  if (!el) return;
  // Remove existing bubbles on this agent (prevent overlap)
  el.querySelectorAll('.chat-bubble').forEach(b => b.remove());
  // Dynamic duration based on text length (min 5s, max 10s)
  if (!duration) duration = Math.max(5000, Math.min(10000, text.length * 120));
  const bubble = document.createElement('div');
  bubble.className = 'chat-bubble' + (cssClass ? ' ' + cssClass : '');
  bubble.innerHTML = text;
  bubble.style.animationDuration = (duration / 1000) + 's';
  el.appendChild(bubble);
  setTimeout(() => bubble.remove(), duration);
}

function setStatus(agentId, status) {
  const dot = canvas.querySelector(`.status-dot[data-agent="${agentId}"]`);
  if (!dot) return;
  dot.className = 'status-dot';
  if (status === 'thinking') dot.classList.add('thinking');
  else if (status === 'busy') dot.classList.add('busy');
}

function flyEnvelope(fromId, toId, label, duration = 1500) {
  return new Promise(resolve => {
    const from = getAgentCenter(fromId);
    const to = getAgentCenter(toId);
    const env = document.createElement('div');
    env.className = 'envelope';
    env.innerHTML = `<span class="envelope-icon">‚úâÔ∏è</span><span class="envelope-label">${label || ''}</span>`;
    env.style.left = from.x + 'px';
    env.style.top = from.y + 'px';
    canvas.appendChild(env);

    const midX = (from.x + to.x) / 2;
    const midY = Math.min(from.y, to.y) - 60;
    const startTime = performance.now();

    function animate(now) {
      const t = Math.min((now - startTime) / duration, 1);
      const ease = t < 0.5 ? 2 * t * t : -1 + (4 - 2 * t) * t;
      const invT = 1 - ease;
      const x = invT * invT * from.x + 2 * invT * ease * midX + ease * ease * to.x;
      const y = invT * invT * from.y + 2 * invT * ease * midY + ease * ease * to.y;
      env.style.left = x + 'px';
      env.style.top = y + 'px';
      env.style.opacity = t > 0.85 ? (1 - t) / 0.15 : Math.min(t / 0.1, 1);
      if (t < 1) requestAnimationFrame(animate);
      else { env.remove(); resolve(); }
    }
    requestAnimationFrame(animate);
  });
}

function agentReact(agentId) {
  const el = agentEls[agentId];
  if (!el) return;
  el.classList.remove('react');
  void el.offsetWidth; // force reflow
  el.classList.add('react');
  setTimeout(() => el.classList.remove('react'), 500);
}

function sparkAt(agentId) {
  const el = agentEls[agentId];
  if (!el) return;
  const spark = document.createElement('div');
  spark.style.cssText = `
    position:absolute; top:-10px; left:50%; transform:translateX(-50%);
    font-size:24px; pointer-events:none; z-index:200;
    animation: sparkFade 0.8s ease forwards;
  `;
  spark.textContent = '‚ú®';
  el.appendChild(spark);
  setTimeout(() => spark.remove(), 800);
}

function addLog(icon, agentName, action, cssClass) {
  const now = new Date();
  const time = now.toTimeString().slice(0, 8);
  const entry = document.createElement('div');
  entry.className = 'log-entry' + (cssClass ? ' ' + cssClass : '');
  entry.innerHTML = `<span class="time">${time}</span>${icon} <span class="agent-name">${agentName}</span> <span class="action">${action}</span>`;
  logEntries.appendChild(entry);
  while (logEntries.children.length > MAX_LOG) logEntries.firstChild.remove();
  logEntries.scrollTop = logEntries.scrollHeight;
}

// === SSE ===
let evtSource = null;

function connectSSE() {
  const dot = document.getElementById('sseDot');
  const label = document.getElementById('sseLabel');

  evtSource = new EventSource('/api/animation/stream');

  evtSource.onopen = () => {
    dot.className = 'sse-dot connected';
    label.textContent = 'Connected';
  };

  evtSource.onmessage = (e) => {
    try {
      const data = JSON.parse(e.data);
      handleEvent(data);
    } catch (_) {}
  };

  evtSource.onerror = () => {
    dot.className = 'sse-dot disconnected';
    label.textContent = 'Reconnecting...';
    evtSource.close();
    setTimeout(connectSSE, 3000);
  };
}

function handleEvent(evt) {
  const from = AGENTS[evt.from];
  const to = AGENTS[evt.to];

  switch (evt.type) {
    case 'message_received':
      agentReact(evt.from);
      showBubble(evt.from, 'Êî∂Âà∞Ôºö' + (evt.text || '').slice(0, 28));
      addLog('üí¨', from?.name || evt.from, 'Êî∂Âà∞Ë®äÊÅØ„Äå' + (evt.text || '') + '„Äç');
      break;

    case 'delegate':
      setStatus(evt.from, 'thinking');
      showBubble(evt.from, 'ÂàÜÊ¥æ‰ªªÂãô...', 'processing', 3000);
      addLog('‚úâÔ∏è', from?.name || evt.from, 'ÂàÜÊ¥æ‰ªªÂãôÁµ¶ ' + (to?.name || evt.to));
      setTimeout(() => {
        flyEnvelope(evt.from, evt.to, evt.text?.slice(0, 15) || '‰ªªÂãô').then(() => {
          agentReact(evt.to);
          sparkAt(evt.to);
        });
        setStatus(evt.from, 'idle');
      }, 800);
      break;

    case 'task_received':
      setStatus(evt.to || evt.from, 'busy');
      agentReact(evt.to || evt.from);
      showBubble(evt.to || evt.from, 'Êî∂Âà∞‰ªªÂãôÔºÅ');
      addLog('üì•', to?.name || from?.name || evt.from, 'Êî∂Âà∞‰ªªÂãô');
      break;

    case 'processing':
      setStatus(evt.from, 'busy');
      showBubble(evt.from, '<span class="spinner"></span>ËôïÁêÜ‰∏≠...', 'processing', 8000);
      addLog('‚öôÔ∏è', from?.name || evt.from, 'ËôïÁêÜ‰∏≠...');
      break;

    case 'task_complete':
      setStatus(evt.from, 'idle');
      agentReact(evt.from);
      showBubble(evt.from, '‚úÖ ÂÆåÊàê', 'success', 4000);
      addLog('‚úÖ', from?.name || evt.from, 'ÂÆåÊàê‰ªªÂãô', 'success');
      if (evt.to) {
        setTimeout(() => {
          flyEnvelope(evt.from, evt.to, 'ÁµêÊûú').then(() => {
            sparkAt(evt.to);
            agentReact(evt.to);
          });
          addLog('‚úâÔ∏è', from?.name || evt.from, 'ÂõûÂÇ≥ÁµêÊûúÁµ¶ ' + (to?.name || evt.to));
        }, 500);
      }
      break;

    case 'status_change':
      setStatus(evt.from, evt.status || 'idle');
      addLog('üîµ', from?.name || evt.from, 'ÁãÄÊÖã ‚Üí ' + (evt.status || 'idle'));
      break;
  }
}

// === DEMO ===
document.getElementById('btnDemo').addEventListener('click', async () => {
  const btn = document.getElementById('btnDemo');
  btn.disabled = true;
  btn.textContent = 'Running...';

  const delay = ms => new Promise(r => setTimeout(r, ms));

  // 1. Kevin receives a message
  handleEvent({ type: 'message_received', from: 'kevin', text: 'Âπ´ÊàëÂØ´‰∏ÄÂÄã REST API' });
  await delay(2000);

  // 2. Kevin thinking
  handleEvent({ type: 'status_change', from: 'kevin', status: 'thinking' });
  await delay(1500);

  // 3. Kevin delegates to Alex
  handleEvent({ type: 'delegate', from: 'kevin', to: 'alex', text: 'ÂØ´ REST API' });
  await delay(2500);

  // 4. Alex receives task
  handleEvent({ type: 'task_received', from: 'alex', to: 'alex' });
  await delay(1500);

  // 5. Alex processing
  handleEvent({ type: 'processing', from: 'alex' });
  await delay(3000);

  // 6. Also delegate to Writer for docs
  handleEvent({ type: 'delegate', from: 'kevin', to: 'writer', text: 'ÂØ´ API Êñá‰ª∂' });
  await delay(2500);
  handleEvent({ type: 'task_received', from: 'writer', to: 'writer' });
  await delay(1000);
  handleEvent({ type: 'processing', from: 'writer' });
  await delay(2500);

  // 7. Writer done
  handleEvent({ type: 'task_complete', from: 'writer', to: 'kevin' });
  await delay(2000);

  // 8. Alex done
  handleEvent({ type: 'task_complete', from: 'alex', to: 'kevin' });
  await delay(2000);

  // 9. Kevin done
  handleEvent({ type: 'message_received', from: 'kevin', text: 'Â∑≤ÂÆåÊàêÔºöREST API + Êñá‰ª∂' });
  handleEvent({ type: 'status_change', from: 'kevin', status: 'idle' });

  btn.disabled = false;
  btn.textContent = 'Demo';
});

// === EDIT MODE ===
let editMode = false;
const DEFAULTS = JSON.parse(JSON.stringify(AGENTS));

// Try load saved positions from localStorage
try {
  const saved = JSON.parse(localStorage.getItem('agentPositions'));
  if (saved) {
    Object.entries(saved).forEach(([id, props]) => {
      if (AGENTS[id]) Object.assign(AGENTS[id], props);
    });
    // Re-apply positions
    Object.entries(AGENTS).forEach(([id, a]) => {
      const el = agentEls[id];
      if (!el) return;
      el.style.left = a.x + '%';
      el.style.top = a.y + '%';
      el.style.width = (a.size || 7) + '%';
      el.style.zIndex = Math.round(a.y);
      el.querySelector('img').src = `assets/agents/${id}_${a.dir}.png`;
    });
  }
} catch(_) {}

function savePositions() {
  const data = {};
  Object.entries(AGENTS).forEach(([id, a]) => {
    data[id] = { x: a.x, y: a.y, dir: a.dir, size: a.size || 7 };
  });
  localStorage.setItem('agentPositions', JSON.stringify(data));
}

function buildEditPanel() {
  const body = document.getElementById('editBody');
  body.innerHTML = '';
  Object.entries(AGENTS).forEach(([id, agent]) => {
    if (!agent.size) agent.size = 7;
    const card = document.createElement('div');
    card.className = 'edit-agent-card';
    card.id = 'editCard_' + id;
    card.innerHTML = `
      <h4>${agent.name}</h4>
      <div class="edit-row">
        <label>X</label>
        <input type="range" min="0" max="100" step="0.5" value="${agent.x}" data-agent="${id}" data-prop="x">
        <span class="val" id="val_${id}_x">${agent.x}%</span>
      </div>
      <div class="edit-row">
        <label>Y</label>
        <input type="range" min="0" max="100" step="0.5" value="${agent.y}" data-agent="${id}" data-prop="y">
        <span class="val" id="val_${id}_y">${agent.y}%</span>
      </div>
      <div class="edit-row">
        <label>Â§ßÂ∞è</label>
        <input type="range" min="3" max="20" step="0.5" value="${agent.size}" data-agent="${id}" data-prop="size">
        <span class="val" id="val_${id}_size">${agent.size}%</span>
      </div>
      <div class="edit-row">
        <label>ÊñπÂêë</label>
        <div class="edit-dir-btns" data-agent="${id}">
          ${['ne','nw','se','sw'].map(d =>
            `<button data-dir="${d}" class="${agent.dir === d ? 'active' : ''}">${d.toUpperCase()}</button>`
          ).join('')}
        </div>
      </div>
    `;
    body.appendChild(card);
  });

  // Range input listeners
  body.querySelectorAll('input[type="range"]').forEach(input => {
    input.addEventListener('input', () => {
      const aid = input.dataset.agent;
      const prop = input.dataset.prop;
      const val = parseFloat(input.value);
      AGENTS[aid][prop] = val;
      document.getElementById(`val_${aid}_${prop}`).textContent = val + '%';
      applyAgentPosition(aid);
      savePositions();
    });
  });

  // Direction buttons
  body.querySelectorAll('.edit-dir-btns').forEach(group => {
    group.querySelectorAll('button').forEach(btn => {
      btn.addEventListener('click', () => {
        const aid = group.dataset.agent;
        const dir = btn.dataset.dir;
        AGENTS[aid].dir = dir;
        group.querySelectorAll('button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        agentEls[aid].querySelector('img').src = `assets/agents/${aid}_${dir}.png`;
        savePositions();
      });
    });
  });
}

function applyAgentPosition(id) {
  const a = AGENTS[id];
  const el = agentEls[id];
  if (!el) return;
  el.style.left = a.x + '%';
  el.style.top = a.y + '%';
  el.style.width = (a.size || 7) + '%';
  el.style.zIndex = Math.round(a.y);
}

// Toggle edit mode
document.getElementById('btnEdit').addEventListener('click', () => {
  editMode = !editMode;
  document.body.classList.toggle('edit-mode', editMode);
  const panel = document.getElementById('editPanel');
  if (editMode) {
    buildEditPanel();
    panel.classList.add('open');
    initDrag();
  } else {
    panel.classList.remove('open');
  }
  document.getElementById('btnEdit').textContent = editMode ? '‚úÖ Done' : '‚úèÔ∏è Edit';
});

document.getElementById('editClose').addEventListener('click', () => {
  editMode = false;
  document.body.classList.remove('edit-mode');
  document.getElementById('editPanel').classList.remove('open');
  document.getElementById('btnEdit').textContent = '‚úèÔ∏è Edit';
});

// Reset
document.getElementById('btnReset').addEventListener('click', () => {
  Object.entries(DEFAULTS).forEach(([id, d]) => {
    Object.assign(AGENTS[id], d);
    AGENTS[id].size = 7;
    applyAgentPosition(id);
    agentEls[id].querySelector('img').src = `assets/agents/${id}_${d.dir}.png`;
  });
  localStorage.removeItem('agentPositions');
  buildEditPanel();
});

// Export
document.getElementById('btnExport').addEventListener('click', () => {
  const data = {};
  Object.entries(AGENTS).forEach(([id, a]) => {
    data[id] = { x: a.x, y: a.y, dir: a.dir, size: a.size || 7 };
  });
  navigator.clipboard.writeText(JSON.stringify(data, null, 2));
  const btn = document.getElementById('btnExport');
  btn.textContent = '‚úÖ Â∑≤Ë§áË£ΩÔºÅ';
  setTimeout(() => btn.textContent = 'Ë§áË£ΩË®≠ÂÆö', 1500);
});

// Drag support
function initDrag() {
  Object.entries(agentEls).forEach(([id, el]) => {
    let dragging = false;
    el.addEventListener('mousedown', (e) => {
      if (!editMode) return;
      e.preventDefault();
      dragging = true;
      el.classList.add('dragging');
      const rect = canvas.getBoundingClientRect();

      function onMove(e2) {
        if (!dragging) return;
        const x = ((e2.clientX - rect.left) / rect.width * 100);
        const y = ((e2.clientY - rect.top) / rect.height * 100);
        AGENTS[id].x = Math.round(Math.max(0, Math.min(100, x)) * 2) / 2;
        AGENTS[id].y = Math.round(Math.max(0, Math.min(100, y)) * 2) / 2;
        applyAgentPosition(id);
        // Update sliders if panel open
        const sx = document.querySelector(`input[data-agent="${id}"][data-prop="x"]`);
        const sy = document.querySelector(`input[data-agent="${id}"][data-prop="y"]`);
        if (sx) { sx.value = AGENTS[id].x; document.getElementById(`val_${id}_x`).textContent = AGENTS[id].x + '%'; }
        if (sy) { sy.value = AGENTS[id].y; document.getElementById(`val_${id}_y`).textContent = AGENTS[id].y + '%'; }
      }

      function onUp() {
        dragging = false;
        el.classList.remove('dragging');
        savePositions();
        document.removeEventListener('mousemove', onMove);
        document.removeEventListener('mouseup', onUp);
      }

      document.addEventListener('mousemove', onMove);
      document.addEventListener('mouseup', onUp);
    });
  });
}

// === IDLE MICRO-ANIMATION ===
// Randomly assign idle bob to agents with staggered delays
Object.keys(agentEls).forEach((id, i) => {
  const el = agentEls[id];
  setTimeout(() => {
    el.style.animationDelay = (Math.random() * 2).toFixed(1) + 's';
    el.classList.add('idle-bob');
  }, i * 500 + Math.random() * 1000);
});

// === INIT ===
connectSSE();
</script>
</body>
</html>
